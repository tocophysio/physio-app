import streamlit as st

# è¨­å®šé é¢é…ç½®
st.set_page_config(
    page_title="1åˆ†é˜éª¨éª¼ç—›ç—‡ç¯©æª¢",
    page_icon="â±ï¸",
    layout="centered"
)

# è‡ªè¨‚ CSS
st.markdown("""
    <style>
    .main-header {
        font-size: 22px;
        font-weight: bold;
        color: #2E86C1;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    .subtitle {
        font-size: 18px;
        font-weight: 600;
        color: #555;
        margin-top: -15px;
        margin-bottom: 20px;
    }
    .danger-box {
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #dc3545;
        color: #721c24;
        margin-bottom: 15px;
    }
    .pattern-box {
        background-color: #e8f4f8;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #2E86C1;
        margin-bottom: 12px;
    }
    .nerve-box {
        background-color: #fff3e0;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #ff9800;
        margin-bottom: 12px;
    }
    .joint-box {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #4caf50;
        margin-bottom: 12px;
    }
    .inflam-box {
        background-color: #fce4ec;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #e91e63;
        margin-bottom: 12px;
    }
    .muscle-box {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #1976d2;
        margin-bottom: 12px;
    }
    .pain-chip {
        display: inline-block;
        padding: 4px 12px;
        margin: 3px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
    }
    .chip-nerve { background-color: #fff3e0; border: 1px solid #ff9800; color: #e65100; }
    .chip-muscle { background-color: #e3f2fd; border: 1px solid #1976d2; color: #0d47a1; }
    .chip-inflam { background-color: #fce4ec; border: 1px solid #e91e63; color: #880e4f; }
    .chip-joint { background-color: #e8f5e9; border: 1px solid #4caf50; color: #1b5e20; }
    .chip-neutral { background-color: #f5f5f5; border: 1px solid #9e9e9e; color: #424242; }
    .stCheckbox label { font-size: 16px; }
    </style>
    """, unsafe_allow_html=True)

# --- æ¨™é¡Œå€åŸŸ ---
st.title("â±ï¸ 1åˆ†é˜éª¨éª¼ç—›ç—‡ç¯©æª¢ç³»çµ±")
st.markdown('<div class="subtitle">Musculoskeletal Screening System</div>', unsafe_allow_html=True)
st.write("è«‹ä¾ç…§æ‚¨çš„å¯¦éš›ç‹€æ³å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œç³»çµ±å°‡å”åŠ©è©•ä¼°é¢¨éšªèˆ‡å‹•ä½œæ¨¡å¼ã€‚")
st.markdown("---")

# --- å…è²¬è²æ˜ ---
st.warning(
    """
    **âš ï¸ å…è²¬è²æ˜ (Disclaimer)**ï¼š
    æœ¬å ±å‘Šåƒ…ä¾›è¡›æ•™ç”¨é€”èˆ‡åˆæ­¥åƒè€ƒï¼Œ**ä¸å¯å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·**ã€‚
    è‹¥æ‚¨æ„Ÿåˆ°åŠ‡çƒˆä¸é©æˆ–æœ‰ç‰¹å®šå¾µå…†ï¼Œè«‹å‹™å¿…è«®è©¢å°ˆç§‘é†«å¸«æˆ–ç‰©ç†æ²»ç™‚å¸«ï¼Œé€²è¡Œå¯¦é«”è‡¨åºŠè©•ä¼°ã€‚
    """
)

if "report_generated" not in st.session_state:
    st.session_state.report_generated = False

# --- è¡¨å–®é–‹å§‹ ---
with st.form("intake_form"):

    # === Section 1: åŸºæœ¬è³‡æ–™ ===
    st.markdown('<div class="main-header">ğŸ“„ 1. åŸºæœ¬è³‡æ–™</div>', unsafe_allow_html=True)
    c1, c2 = st.columns(2)
    with c1:
        gender = st.selectbox("ç”Ÿç†æ€§åˆ¥", ["è«‹é¸æ“‡", "ç”·", "å¥³"], index=0)
    with c2:
        age = st.selectbox("å¹´é½¡å€é–“", ["18æ­²ä»¥ä¸‹", "19-30æ­²", "31-45æ­²", "46-60æ­²", "60æ­²ä»¥ä¸Š"], index=2)

    occupation = st.selectbox("è·æ¥­é¡å‹", [
        "éœæ…‹ä¹…åé¡ (è¾¦å…¬å®¤/å¸æ©Ÿ)",
        "å‹åŠ›å·¥ä½œé¡ (æ¬é‹/å·¥åœ°)",
        "ä¹…ç«™æœå‹™é¡ (å°ˆæ«ƒ/é¤é£²)",
        "å®¶å‹™æ“æŒ",
        "é‹å‹•å“¡/æ•™ç·´",
        "é€€ä¼‘/å…¶ä»–"
    ])

    # === Section 2: æ‚£è™•å®šä½ ===
    st.markdown('<div class="main-header">ğŸ“ 2. æ‚£è™•å®šä½</div>', unsafe_allow_html=True)
    pain_location = st.selectbox("ä¸»è¦ç–¼ç—›ä½ç½®", [
        "-- è«‹é¸æ“‡ --", "é ¸æ¤/é ­éƒ¨", "è‚©è†€/ä¸Šè‚¢", "è…°æ¤/ä¸‹èƒŒ",
        "é«–éƒ¨/éª¨ç›†", "è†è“‹", "è…³è¸/è¶³éƒ¨", "å…¶ä»–"
    ])

    vas_score = st.slider("ç›®å‰ç–¼ç—›åˆ†æ•¸ (0ä¸ç—› ~ 10åŠ‡ç—›)", 0, 10, 5)

    # === Section 3: ç–¼ç—›æ€§è³ª (æ–°å¢) ===
    st.markdown('<div class="main-header">ğŸ¯ 3. ç–¼ç—›æ€§è³ª</div>', unsafe_allow_html=True)
    st.caption("ä¸åŒçš„ç–¼ç—›æ„Ÿè¦ºå¯èƒ½æš—ç¤ºä¸åŒçš„çµ„ç¹”å—æï¼Œè«‹é¸æ“‡æœ€ç¬¦åˆæ‚¨æ„Ÿå—çš„æè¿°ï¼ˆå¯è¤‡é¸ï¼‰")

    pain_quality_options = [
        "éº»ç—º/æ”¾å°„æ„Ÿ â€” åƒé›»æµç«„éã€å»¶ä¼¸åˆ°é ç«¯",
        "é‡åˆºç—› â€” åƒè¢«é‡æ‰ã€åˆºåˆºçš„",
        "éˆç—› â€” æ‚¶æ‚¶çš„ã€æ·±å±¤çš„ä¸èˆ’æœ",
        "ç¼ç†±æ„Ÿ â€” åƒç‡’ç‡™ã€ç†±è¾£è¾£çš„æ„Ÿè¦º",
        "ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ â€” åƒè¢«æ‹‰ä½ã€ç¹ƒä½",
        "é…¸ç—› â€” åƒé‹å‹•å¾Œçš„ç— ã€ä½¿ä¸ä¸ŠåŠ›",
        "æŒ‰å£“ç—› â€” å£“ä¸‹å»æ‰ç—›ã€æœ‰æ˜ç¢ºç—›é»",
    ]

    pain_quality = st.multiselect(
        "æ‚¨çš„ç–¼ç—›æ„Ÿè¦ºæœ€æ¥è¿‘å“ªäº›ï¼Ÿ(å¯è¤‡é¸)",
        options=pain_quality_options
    )

    # === Section 4: ç´…æ——è­¦è¨Š ===
    st.markdown('<div class="main-header">ğŸ›¡ï¸ 4. å±éšªå¾µå…†ç¯©æª¢ (Red Flags)</div>', unsafe_allow_html=True)
    st.info("æ­¤å€å¡Šç”¨æ–¼ç¯©æª¢æ˜¯å¦éœ€è¦ã€Œç«‹å³å°±é†«ã€ã€‚è«‹å‹¾é¸æ‚¨ç›®å‰ **ç¬¦åˆ** çš„ç‹€æ³ï¼š")

    red_flag_options = [
        "æœ‰å¤§å°ä¾¿æ§åˆ¶å•é¡Œ (å¤±ç¦æˆ–æ’å°¿å›°é›£)",
        "è¿‘æœŸé«”é‡æœ‰ä¸æ˜åŸå› çš„å¿«é€Ÿæ¸›è¼•",
        "ä¼´éš¨ç™¼ç‡’ã€ç•å¯’æˆ–åš´é‡å¤œé–“ç—› (ç—›åˆ°é†’ä¾†)",
        "æ›¾ç¶“æœ‰åš´é‡å¤–å‚·/è·Œå€’å¾Œæ‰å‡ºç¾ç–¼ç—›",
        "ä¼‘æ¯ä¸å‹•æ™‚ä¹ŸæœƒåŠ‡çƒˆç–¼ç—› (Rest Pain)",
        "é›™è…³/é›™æ‰‹åŒæ™‚å‡ºç¾éº»æœ¨æˆ–ç„¡åŠ›",
        "èƒ¸ç—›ä¼´éš¨å‘¼å¸å›°é›£"
    ]

    selected_red_flags = st.multiselect(
        "è«‹ä¸‹æ‹‰é¸æ“‡ (è‹¥ç„¡ä¸‹åˆ—ç—‡ç‹€ï¼Œè«‹é¸æ“‡ã€Œçš†æ²’æœ‰ã€)ï¼š",
        options=["çš†æ²’æœ‰"] + red_flag_options,
        default=["çš†æ²’æœ‰"]
    )

    # === Section 5: ç—‡ç‹€ç‰¹å¾µèˆ‡åŠŸèƒ½å½±éŸ¿ ===
    st.markdown('<div class="main-header">ğŸ” 5. ä¼´éš¨ç—‡ç‹€èˆ‡åŠŸèƒ½å½±éŸ¿</div>', unsafe_allow_html=True)

    col_sym1, col_sym2 = st.columns(2)
    with col_sym1:
        st.markdown("**ä¼´éš¨ç—‡ç‹€ (å¯è¤‡é¸):**")
        symptoms = []
        if st.checkbox("æ„Ÿåˆ°ç„¡åŠ› (Weakness)"): symptoms.append("ç„¡åŠ›")
        if st.checkbox("æ„Ÿè¦ºå¡ä½äº† (Locking/Clicking)"): symptoms.append("å¡ä½æ„Ÿ")
        if st.checkbox("è§’åº¦ä¸Šä¸å»/æ´»å‹•å—é™ (ROM loss)"): symptoms.append("è§’åº¦å—é™")

    with col_sym2:
        st.markdown("**åŠŸèƒ½å½±éŸ¿ (å¯è¤‡é¸):**")
        impacts = []
        if st.checkbox("å½±éŸ¿æ—¥å¸¸æ´»å‹• (ç©¿è¡£/å·¥ä½œ)"): impacts.append("å½±éŸ¿æ—¥å¸¸")
        if st.checkbox("å½±éŸ¿ç¡çœ  (Sleep disturbance)"): impacts.append("å½±éŸ¿ç¡çœ ")
        if st.checkbox("éœ€è¦è—¥ç‰©æ­¢ç—›"): impacts.append("éœ€è—¥ç‰©æ­¢ç—›")
        if st.checkbox("å¤±å»å¹³è¡¡/å®¹æ˜“è·Œå€’"): impacts.append("å¤±å»å¹³è¡¡")

    # === Section 6: å‹•ä½œæ¨¡å¼æª¢æ¸¬ ===
    st.markdown('<div class="main-header">ğŸš¶ 6. å‹•ä½œæ¨¡å¼æª¢æ¸¬</div>', unsafe_allow_html=True)

    st.markdown("**ğŸ˜« ä»€éº¼æ™‚å€™æ¯”è¼ƒç—› (èª˜ç™¼å› å­)?**")
    triggers = st.multiselect("è«‹é¸æ“‡æœƒåŠ åŠ‡ç–¼ç—›çš„å‹•ä½œ (å¯è¤‡é¸)", [
        "ä¹…å", "ä¹…ç«™", "èµ°è·¯", "ä¸Šæ¨“æ¢¯", "ä¸‹æ¨“æ¢¯",
        "è½‰èº«/è½‰å½", "ä¸€å‹•å°±ç—›", "ä¸å‹•ä¹Ÿç—›", "å½è…°", "å¾Œä»°/æŒºèº«", "æ‰‹èˆ‰é«˜"
    ])

    st.markdown("**ğŸ˜Œ åšä»€éº¼æ¯”è¼ƒèˆ’æœ (ç·©è§£å› å­)?**")
    relievers = st.multiselect("è«‹é¸æ“‡æœƒæ¸›è¼•ç–¼ç—›çš„æ–¹å¼ (å¯è¤‡é¸)", [
        "ä¼‘æ¯/ä¸æ´»å‹•", "ç†±æ•·", "å†°æ•·", "æ”¹è®Šå§¿å‹¢",
        "æ™šä¸Šè¼ƒæ¸›ç·©", "èµ°è·¯/æ´»å‹•å¾Œ", "æ²’æœ‰æ”¹å–„"
    ])

    # === é€å‡ºæŒ‰éˆ• ===
    st.markdown("---")
    submit_btn = st.form_submit_button("ğŸ“‹ ç”¢ç”Ÿè©•ä¼°å ±å‘Š", use_container_width=True)


# ------------------------------------------------------------------
# Helperï¼šè§£æç–¼ç—›æ€§è³ªé—œéµå­—
# ------------------------------------------------------------------
def parse_pain_quality(pain_quality_list):
    """å°‡ä½¿ç”¨è€…é¸æ“‡çš„ç–¼ç—›æ€§è³ªåˆ†é¡ç‚ºç¥ç¶“/è‚Œè‚‰/ç™¼ç‚/é—œç¯€ç­‰æ¨™ç±¤"""
    tags = {
        "nerve": [],    # ç¥ç¶“ç›¸é—œ
        "muscle": [],   # è‚Œè‚‰ç­‹è†œ
        "inflam": [],   # ç™¼ç‚ç›¸é—œ
        "joint": [],    # é—œç¯€/çµæ§‹
    }
    for pq in pain_quality_list:
        if "éº»ç—º" in pq or "æ”¾å°„" in pq:
            tags["nerve"].append("éº»ç—º/æ”¾å°„æ„Ÿ")
        if "é‡åˆº" in pq:
            tags["nerve"].append("é‡åˆºç—›")
        if "éˆç—›" in pq:
            tags["joint"].append("éˆç—›")
        if "ç¼ç†±" in pq:
            tags["inflam"].append("ç¼ç†±æ„Ÿ")
        if "ç·Šç¹ƒ" in pq or "æ‹‰æ‰¯" in pq:
            tags["muscle"].append("ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ")
        if "é…¸ç—›" in pq:
            tags["muscle"].append("é…¸ç—›")
        if "æŒ‰å£“" in pq:
            tags["muscle"].append("æŒ‰å£“ç—›")
    return tags


# --- é‚è¼¯è™•ç†èˆ‡å ±å‘Šç”Ÿæˆ ---
if submit_btn:
    validation_errors = []
    if gender == "è«‹é¸æ“‡":
        validation_errors.append("è«‹é¸æ“‡ç”Ÿç†æ€§åˆ¥")
    if pain_location == "-- è«‹é¸æ“‡ --":
        validation_errors.append("è«‹é¸æ“‡ç–¼ç—›éƒ¨ä½")

    if validation_errors:
        for err in validation_errors:
            st.error(f"âŒ {err}")
    else:
        st.session_state.report_generated = True

        # ç´…æ——é‚è¼¯
        has_red_flags = False
        valid_red_flags = []
        if "çš†æ²’æœ‰" in selected_red_flags and len(selected_red_flags) > 1:
            valid_red_flags = [x for x in selected_red_flags if x != "çš†æ²’æœ‰"]
            has_red_flags = True
        elif "çš†æ²’æœ‰" in selected_red_flags:
            has_red_flags = False
        elif not selected_red_flags:
            has_red_flags = False
        else:
            valid_red_flags = selected_red_flags
            has_red_flags = True

        # è§£æç–¼ç—›æ€§è³ª
        pain_tags = parse_pain_quality(pain_quality)
        has_nerve_pain = len(pain_tags["nerve"]) > 0
        has_muscle_pain = len(pain_tags["muscle"]) > 0
        has_inflam_pain = len(pain_tags["inflam"]) > 0
        has_joint_pain = len(pain_tags["joint"]) > 0

        # === é¡¯ç¤ºå ±å‘Š ===
        st.markdown("---")
        st.markdown("## ğŸ“Š åˆæ­¥ç¯©æª¢å ±å‘Š")
        st.markdown('<div class="subtitle">Screening Report</div>', unsafe_allow_html=True)

        # --- 1. ç´…æ——è­¦è¨Š ---
        if has_red_flags:
            st.markdown(f"""
            <div class="danger-box">
                <h4>ğŸš¨ è­¦å‘Šï¼šæª¢æ¸¬åˆ°ç´…æ——è­¦è¨Š (Red Flags)</h4>
                <p>æ‚¨å‹¾é¸äº†ä»¥ä¸‹å±éšªå¾µå…†ï¼š</p>
                <ul>{''.join([f'<li>{flag}</li>' for flag in valid_red_flags])}</ul>
                <p><strong>å»ºè­°ï¼š</strong>é€™äº›ç—‡ç‹€å¯èƒ½ä»£è¡¨è¼ƒåš´é‡çš„ç—…ç†å•é¡Œï¼ˆå¦‚ç¥ç¶“å£“è¿«ã€æ„ŸæŸ“ã€éª¨æŠ˜ç­‰ï¼‰ï¼Œ
                <b>è«‹å‹¿å–®ç´”ä¾è³´é‹å‹•æ”¹å–„ï¼Œå»ºè­°å„˜é€Ÿå‰å¾€é†«é™¢æ¥å—å°ˆç§‘é†«å¸«æª¢æŸ¥ã€‚</b></p>
            </div>
            """, unsafe_allow_html=True)
        else:
            st.success("âœ… ç´…æ——è­¦è¨Šç¯©æª¢ï¼šæœªç™¼ç¾æ˜é¡¯å±éšªå¾µå…† (Safe to proceed with care)")

        # --- 2. æ‘˜è¦è³‡è¨Š ---
        st.markdown("#### ğŸ“ ç‹€æ³æ‘˜è¦")

        info_c1, info_c2, info_c3 = st.columns(3)
        with info_c1:
            st.metric("æ€§åˆ¥", gender)
        with info_c2:
            st.metric("å¹´é½¡", age)
        with info_c3:
            st.metric("ç–¼ç—›æŒ‡æ•¸", f"{vas_score}/10")

        c_res1, c_res2 = st.columns(2)
        with c_res1:
            st.write(f"**ğŸ“ éƒ¨ä½:** {pain_location}")
            st.write(f"**ğŸ’¼ è·æ¥­:** {occupation}")
            st.write(f"**ğŸ©º ä¼´éš¨ç—‡ç‹€:** {'ã€'.join(symptoms) if symptoms else 'ç„¡'}")
        with c_res2:
            st.write(f"**âš¡ åŠŸèƒ½å½±éŸ¿:** {'ã€'.join(impacts) if impacts else 'å°šå¯'}")
            st.write(f"**ğŸ˜« èª˜ç™¼å› å­:** {'ã€'.join(triggers) if triggers else 'æœªé¸æ“‡'}")
            st.write(f"**ğŸ˜Œ ç·©è§£å› å­:** {'ã€'.join(relievers) if relievers else 'æœªé¸æ“‡'}")

        # --- 2b. ç–¼ç—›æ€§è³ªè¦–è¦ºåŒ– ---
        st.markdown("---")
        st.markdown("#### ğŸ¯ ç–¼ç—›æ€§è³ªåˆ†æ")

        if pain_quality:
            # é¡¯ç¤ºç–¼ç—›æ¨™ç±¤ chips
            chip_map = {
                "éº»ç—º/æ”¾å°„æ„Ÿ": "chip-nerve",
                "é‡åˆºç—›": "chip-nerve",
                "éˆç—›": "chip-joint",
                "ç¼ç†±æ„Ÿ": "chip-inflam",
                "ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ": "chip-muscle",
                "é…¸ç—›": "chip-muscle",
                "æŒ‰å£“ç—›": "chip-muscle",
            }

            chips_html = ""
            for pq in pain_quality:
                # å–å¾—ç°¡çŸ­æ¨™ç±¤
                short = pq.split("â€”")[0].strip()
                css_class = "chip-neutral"
                for key, cls in chip_map.items():
                    if key in short:
                        css_class = cls
                        break
                chips_html += f'<span class="pain-chip {css_class}">{short}</span>'

            st.markdown(f"**æ‚¨é¸æ“‡çš„ç–¼ç—›æ„Ÿè¦ºï¼š**{chips_html}", unsafe_allow_html=True)
            st.write("")

            # --- ç–¼ç—›æ€§è³ªåˆ¤è®€ ---
            pain_interp = []

            # ç¥ç¶“æ€§ç–¼ç—›
            if has_nerve_pain:
                nerve_items = pain_tags["nerve"]
                detail = ""
                if "éº»ç—º/æ”¾å°„æ„Ÿ" in nerve_items and "é‡åˆºç—›" in nerve_items:
                    detail = (
                        "æ‚¨åŒæ™‚æœ‰ **éº»ç—ºæ”¾å°„æ„Ÿ + é‡åˆºç—›**ï¼Œé€™æ˜¯é«˜åº¦æ‡·ç–‘ **ç¥ç¶“æ€§ç–¼ç—› (Neuropathic Pain)** çš„çµ„åˆã€‚\n\n"
                        "- ã€Œæ”¾å°„æ„Ÿã€ä»£è¡¨ç–¼ç—›æ²¿è‘—ç¥ç¶“èµ°å‘å‚³å°ï¼ˆå¦‚å¾è…°â†’è‡€â†’è…¿ï¼Œæˆ–å¾é ¸â†’è‚©â†’æ‰‹ï¼‰\n"
                        "- ã€Œé‡åˆºç—›ã€æ˜¯ç¥ç¶“å—åˆºæ¿€æ™‚çš„å…¸å‹æ„Ÿè¦º\n"
                        "- å¸¸è¦‹æ–¼ï¼šæ¤é–“ç›¤çªå‡ºå£“è¿«ã€ç¥ç¶“æ ¹ç—…è®Šã€å‘¨é‚Šç¥ç¶“å¡å£“\n\n"
                        "âš ï¸ **å»ºè­°**ï¼šè¨˜éŒ„éº»ç—ºçš„ç¯„åœæ˜¯å¦æ²¿ç‰¹å®šè·¯ç·šå»¶ä¼¸ï¼Œå°±é†«æ™‚å¯æä¾›é†«å¸«ä½œç‚ºè¨ºæ–·ä¾æ“šã€‚"
                    )
                elif "éº»ç—º/æ”¾å°„æ„Ÿ" in nerve_items:
                    detail = (
                        "æ‚¨æœ‰ **éº»ç—ºæˆ–æ”¾å°„æ„Ÿ**ï¼Œç–¼ç—›å¯èƒ½å¾ä¸€å€‹é»ã€Œç«„ã€åˆ°å…¶ä»–éƒ¨ä½ã€‚\n\n"
                        "- é€™é€šå¸¸ä»£è¡¨ **ç¥ç¶“å—åˆ°å£“è¿«æˆ–åˆºæ¿€**\n"
                        "- å¸¸è¦‹æ¨¡å¼ï¼šè…°ç—›æ”¾å°„åˆ°è…¿ (åéª¨ç¥ç¶“)ã€é ¸ç—›æ”¾å°„åˆ°æ‰‹ (é ¸ç¥ç¶“æ ¹)\n"
                        "- è‹¥æ”¾å°„æ„Ÿè¶Šä¾†è¶Šé  (ä¾‹å¦‚å¾å¤§è…¿â†’å°è…¿â†’è…³è¶¾)ï¼Œä»£è¡¨å£“è¿«å¯èƒ½åŠ é‡\n\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šé¿å…æœƒåŠ é‡æ”¾å°„æ„Ÿçš„å§¿å‹¢ï¼Œä¸¦ç›¡æ—©å®‰æ’ç¥ç¶“å­¸è©•ä¼°ã€‚"
                    )
                elif "é‡åˆºç—›" in nerve_items:
                    detail = (
                        "æ‚¨æœ‰ **é‡åˆºç—›** çš„æ„Ÿè¦ºï¼Œåƒè¢«é‡æ‰æˆ–é›»åˆ°ã€‚\n\n"
                        "- é€™å¯èƒ½æ˜¯ **å°çº–ç¶­ç¥ç¶“å—åˆºæ¿€** çš„è¡¨ç¾\n"
                        "- å¸¸è¦‹æ–¼ï¼šç¥ç¶“å¡å£“åˆæœŸã€ç³–å°¿ç—…å‘¨é‚Šç¥ç¶“ç—…è®Šã€å¸¶ç‹€ç–±ç–¹å¾Œç¥ç¶“ç—›\n"
                        "- è‹¥é‡åˆºæ„Ÿä¾·é™åœ¨ç‰¹å®šå€åŸŸï¼Œå¯èƒ½èˆ‡å±€éƒ¨ç¥ç¶“å—å£“æœ‰é—œ\n\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šè‹¥æŒçºŒè¶…é2é€±ä¸”ç¯„åœæ“´å¤§ï¼Œå»ºè­°å®‰æ’ç¥ç¶“å‚³å°æª¢æŸ¥ã€‚"
                    )
                if detail:
                    pain_interp.append(("nerve-box", "ğŸ”¶ ç¥ç¶“æ€§ç–¼ç—›ç‰¹å¾µ (Neuropathic Features)", detail))

            # è‚Œè‚‰ç­‹è†œç–¼ç—›
            if has_muscle_pain:
                muscle_items = pain_tags["muscle"]
                detail = ""

                if "æŒ‰å£“ç—›" in muscle_items and ("ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ" in muscle_items or "é…¸ç—›" in muscle_items):
                    detail = (
                        "æ‚¨æœ‰ **æŒ‰å£“ç—› + ç·Šç¹ƒ/é…¸ç—›**ï¼Œé€™æ˜¯å…¸å‹çš„ **è‚Œç­‹è†œç–¼ç—› (Myofascial Pain)** ç‰¹å¾µã€‚\n\n"
                        "- ã€ŒæŒ‰å£“ç—›ã€ä»£è¡¨æœ‰æ˜ç¢ºçš„å£“ç—›é» (Trigger Point)ï¼Œå£“ä¸‹å»ç‰¹åˆ¥ç—›\n"
                        "- ã€Œç·Šç¹ƒ/é…¸ç—›ã€ä»£è¡¨è‚Œè‚‰é•·æœŸè™•æ–¼ç·Šå¼µæˆ–éåº¦ä½¿ç”¨ç‹€æ…‹\n"
                        "- å¸¸è¦‹æ–¼ï¼šè‚©é ¸ç— ç—›ã€è…°èƒŒè‚Œç­‹è†œç‚ã€ç¶²çƒè‚˜çš„è‚Œè…±é™„è‘—é»\n\n"
                        "âœ… **å¥½æ¶ˆæ¯**ï¼šè‚Œç­‹è†œå•é¡Œé€šå¸¸å°ç‰©ç†æ²»ç™‚åæ‡‰è‰¯å¥½ã€‚\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šç†±æ•· + ä¼¸å±• + æŒ‰æ‘©å£“ç—›é»ï¼Œä¸¦èª¿æ•´é€ æˆç·Šç¹ƒçš„å§¿å‹¢æˆ–å‹•ä½œã€‚"
                    )
                elif "æŒ‰å£“ç—›" in muscle_items:
                    detail = (
                        "æ‚¨æœ‰ **æŒ‰å£“ç—›**ï¼Œä»£è¡¨æœ‰æ˜ç¢ºçš„å±€éƒ¨å£“ç—›é»ã€‚\n\n"
                        "- å¯èƒ½æ˜¯è‚Œç­‹è†œè§¸ç™¼é» (Trigger Point) æˆ–è‚Œè…±/éŸŒå¸¶é™„è‘—è™•ç™¼ç‚\n"
                        "- è‹¥ç—›é»éå¸¸ç²¾ç¢ºï¼ˆä¸€æŒ‡å¯æŒ‡å‡ºï¼‰ï¼Œæ›´å‚¾å‘å±€éƒ¨è»Ÿçµ„ç¹”å•é¡Œ\n\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šå˜—è©¦è¼•æŸ”çš„æŒ‰å£“æ”¾é¬†æˆ–æ»¾ç­’æ”¾é¬†ï¼Œè‹¥æŒ‰å£“å¾ŒçŸ­æš«åŠ åŠ‡ä½†ä¹‹å¾Œæ”¹å–„ï¼Œå±¬æ­£å¸¸åæ‡‰ã€‚"
                    )
                elif "ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ" in muscle_items:
                    detail = (
                        "æ‚¨æœ‰ **ç·Šç¹ƒæˆ–æ‹‰æ‰¯æ„Ÿ**ï¼Œåƒè‚Œè‚‰è¢«æ‹‰ä½æˆ–ç¹ƒä½ã€‚\n\n"
                        "- å¸¸è¦‹æ–¼ï¼šé•·æ™‚é–“å§¿å‹¢ä¸è‰¯ã€è‚Œè‚‰éåº¦ä½¿ç”¨å¾Œçš„ä¿è­·æ€§ç—™æ”£\n"
                        "- è‹¥ã€Œæ‹‰æ‰¯æ„Ÿã€ä¼´éš¨ç‰¹å®šå‹•ä½œæ‰å‡ºç¾ï¼Œå¯èƒ½èˆ‡è‚Œè‚‰æŸ”è»Ÿåº¦ä¸è¶³æœ‰é—œ\n\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šé©åº¦ä¼¸å±•ã€ç†±æ•·ã€èª¿æ•´å§¿å‹¢é€šå¸¸èƒ½æœ‰æ•ˆç·©è§£ã€‚"
                    )
                elif "é…¸ç—›" in muscle_items:
                    detail = (
                        "æ‚¨æœ‰ **é…¸ç—›æ„Ÿ**ï¼Œåƒé‹å‹•å¾Œçš„ç–²å‹æ„Ÿã€‚\n\n"
                        "- å¯èƒ½æ˜¯è‚Œè‚‰éåº¦ä½¿ç”¨ã€ä¹³é…¸å †ç©ã€æˆ–æ…¢æ€§è‚Œè‚‰ç–²å‹\n"
                        "- è‹¥é…¸ç—›åœ¨æ´»å‹•å¾ŒåŠ åŠ‡ä½†ä¼‘æ¯æœƒæ”¹å–„ï¼Œå‚¾å‘è‚Œè‚‰è² è·å•é¡Œ\n"
                        "- è‹¥é…¸ç—›æŒçºŒä¸é€€ï¼Œå¯èƒ½éœ€è€ƒæ…®è‚Œè‚‰æœ¬èº«çš„ç—…è®Šæˆ–ä»£è¬å•é¡Œ\n\n"
                        "ğŸ’¡ **å»ºè­°**ï¼šé©åº¦æ´»å‹• + å……è¶³ä¼‘æ¯ï¼Œé¿å…çªç„¶å¤§å¹…å¢åŠ é‹å‹•é‡ã€‚"
                    )
                if detail:
                    pain_interp.append(("muscle-box", "ğŸ”µ è‚Œè‚‰/ç­‹è†œç–¼ç—›ç‰¹å¾µ (Myofascial Features)", detail))

            # ç™¼ç‚æ€§ç–¼ç—›
            if has_inflam_pain:
                detail = (
                    "æ‚¨æœ‰ **ç¼ç†±æ„Ÿ**ï¼Œåƒç‡’ç‡™æˆ–ç†±è¾£è¾£çš„æ„Ÿè¦ºã€‚\n\n"
                    "é€™å¯èƒ½ä»£è¡¨ï¼š\n"
                    "- **æ€¥æ€§ç™¼ç‚åæ‡‰**ï¼šçµ„ç¹”å—å‚·å¾Œçš„ç™¼ç‚åæ‡‰ï¼Œå±€éƒ¨æœƒæœ‰ç´…ã€è…«ã€ç†±ã€ç—›\n"
                    "- **ç¥ç¶“æ€§ç¼ç†±**ï¼šç¥ç¶“å—æä¹Ÿå¯èƒ½ç”¢ç”Ÿç¼ç‡’æ„Ÿ (å¦‚è¤‡é›œæ€§å€åŸŸç–¼ç—›ç—‡å€™ç¾¤ CRPS)\n"
                    "- **åŒ–å­¸æ€§åˆºæ¿€**ï¼šè‚Œè…±ç‚ã€æ»‘å›Šç‚ç­‰ç™¼ç‚ç‰©è³ªåˆºæ¿€å‘¨é‚Šçµ„ç¹”\n\n"
                )
                if has_nerve_pain:
                    detail += "âš ï¸ æ‚¨åŒæ™‚æœ‰ç¥ç¶“æ€§ç—‡ç‹€ + ç¼ç†±æ„Ÿï¼Œéœ€æ³¨æ„æ˜¯å¦ç‚º **ç¥ç¶“æ€§ç¼ç†±ç—› (Burning Neuropathic Pain)**ï¼Œå»ºè­°å°±é†«è©•ä¼°ã€‚\n\n"
                detail += "ğŸ’¡ **å»ºè­°**ï¼šæ€¥æ€§æœŸå¯å˜—è©¦å†°æ•·é™æº«ï¼Œè‹¥ç¼ç†±æ„ŸæŒçºŒè¶…é2é€±ï¼Œå»ºè­°å°±é†«æª¢æŸ¥ã€‚"
                pain_interp.append(("inflam-box", "ğŸ”´ ç™¼ç‚/ç¼ç†±ç‰¹å¾µ (Inflammatory Features)", detail))

            # æ·±å±¤/é—œç¯€æ€§ç–¼ç—›
            if has_joint_pain:
                detail = (
                    "æ‚¨æœ‰ **éˆç—›**ï¼Œä¸€ç¨®æ‚¶æ‚¶çš„ã€æ·±å±¤çš„ä¸èˆ’æœæ„Ÿã€‚\n\n"
                    "- éˆç—›é€šå¸¸ä¾†è‡ª **è¼ƒæ·±å±¤çš„çµæ§‹**ï¼šé—œç¯€ã€éª¨éª¼ã€æ·±å±¤è‚Œè‚‰\n"
                    "- å¸¸è¦‹æ–¼ï¼šé€€åŒ–æ€§é—œç¯€ç‚ã€æ¤é–“ç›¤å•é¡Œã€éª¨é ­å…§éƒ¨å£“åŠ›\n"
                    "- è‹¥éˆç—›åœ¨ç‰¹å®šå§¿å‹¢ (å¦‚ä¹…åå¾Œ) åŠ åŠ‡ï¼Œå¯èƒ½èˆ‡é—œç¯€é¢å£“åŠ›åˆ†ä½ˆæœ‰é—œ\n\n"
                )
                if "å¡ä½æ„Ÿ" in symptoms:
                    detail += "âš ï¸ åˆä½µã€Œå¡ä½æ„Ÿã€ï¼Œæ›´æ”¯æŒé—œç¯€å…§éƒ¨çµæ§‹ (å¦‚åŠæœˆæ¿ã€é—œç¯€å”‡) çš„å•é¡Œã€‚\n\n"
                if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                    detail += "ğŸ“Œ æ‚¨çš„å¹´é½¡å±¤è¼ƒå®¹æ˜“å‡ºç¾é€€åŒ–æ€§å•é¡Œï¼Œéˆç—›å¯èƒ½èˆ‡è»Ÿéª¨ç£¨ææˆ–éª¨è³ªè®ŠåŒ–æœ‰é—œã€‚\n\n"
                detail += "ğŸ’¡ **å»ºè­°**ï¼šéˆç—›è‹¥æŒçºŒä¸”é€æ¼¸åŠ é‡ï¼Œå»ºè­°å®‰æ’Xå…‰æˆ–MRIæª¢æŸ¥ï¼Œäº†è§£é—œç¯€æˆ–éª¨éª¼ç‹€æ…‹ã€‚"
                pain_interp.append(("joint-box", "ğŸŸ¢ æ·±å±¤/é—œç¯€æ€§ç–¼ç—›ç‰¹å¾µ (Deep/Articular Features)", detail))

            # --- ç¶œåˆç–¼ç—›æ¨¡å¼åˆ¤è®€ ---
            if has_nerve_pain and has_muscle_pain:
                pain_interp.append(("pattern-box", "ğŸ”€ æ··åˆæ¨¡å¼ï¼šç¥ç¶“ + è‚Œè‚‰ (Mixed Pattern)", (
                    "æ‚¨åŒæ™‚æœ‰ **ç¥ç¶“æ€§** å’Œ **è‚Œè‚‰æ€§** çš„ç–¼ç—›ç‰¹å¾µï¼Œé€™åœ¨è‡¨åºŠä¸Šéå¸¸å¸¸è¦‹ã€‚\n\n"
                    "- å¸¸è¦‹æƒ…å¢ƒï¼šç¥ç¶“è¢«å£“è¿«å¾Œï¼Œå‘¨é‚Šè‚Œè‚‰æœƒä¿è­·æ€§æ”¶ç¸® â†’ å°è‡´äºŒæ¬¡æ€§è‚Œè‚‰ç–¼ç—›\n"
                    "- ä¾‹å¦‚ï¼šæ¤é–“ç›¤å£“è¿«ç¥ç¶“ (éº»ç—ºæ”¾å°„) + è…°éƒ¨è‚Œè‚‰ç—™æ”£ (ç·Šç¹ƒé…¸ç—›)\n\n"
                    "ğŸ’¡ **å»ºè­°**ï¼šæ²»ç™‚æ™‚éœ€åŒæ™‚è™•ç†ç¥ç¶“å£“è¿«å’Œè‚Œè‚‰ç·Šç¹ƒï¼Œå–®ç¨è™•ç†å…¶ä¸­ä¸€å€‹å¯èƒ½æ•ˆæœæœ‰é™ã€‚"
                )))

            if has_nerve_pain and has_inflam_pain:
                pain_interp.append(("nerve-box", "ğŸ”€ æ··åˆæ¨¡å¼ï¼šç¥ç¶“ + ç™¼ç‚ (Neuro-Inflammatory)", (
                    "æ‚¨æœ‰ **ç¥ç¶“æ€§** å’Œ **ç™¼ç‚æ€§** çš„ç–¼ç—›ç‰¹å¾µåŒæ™‚å‡ºç¾ã€‚\n\n"
                    "- é€™å¯èƒ½ä»£è¡¨ç¥ç¶“æœ¬èº«æ­£åœ¨ç™¼ç‚ (Neuritis)\n"
                    "- æˆ–ç™¼ç‚ç‰©è³ªåˆºæ¿€åˆ°é™„è¿‘çš„ç¥ç¶“\n\n"
                    "âš ï¸ **å»ºè­°**ï¼šé€™ç¨®çµ„åˆéœ€è¦ç©æ¥µè™•ç†ï¼Œå»ºè­°å°±é†«è©•ä¼°æ˜¯å¦éœ€è¦æ¶ˆç‚æ²»ç™‚ã€‚"
                )))

            # Display pain quality analysis
            if pain_interp:
                for box_class, title, detail in pain_interp:
                    st.markdown(f'<div class="{box_class}"><b>{title}</b></div>', unsafe_allow_html=True)
                    st.markdown(detail)
                    st.write("")
            else:
                st.info("â„¹ï¸ æ‚¨é¸æ“‡çš„ç–¼ç—›æ€§è³ªå°šç„¡æ³•æ˜ç¢ºæ­¸é¡ï¼Œå»ºè­°ç”±å°ˆæ¥­äººå“¡é€²ä¸€æ­¥è©•ä¼°ã€‚")

        else:
            st.info("â„¹ï¸ æ‚¨æœªé¸æ“‡ç–¼ç—›æ€§è³ªï¼Œæ­¤éƒ¨åˆ†ç„¡æ³•é€²è¡Œåˆ†æã€‚å»ºè­°ä¸‹æ¬¡å¡«å¯«æ™‚å˜—è©¦æè¿°æ‚¨çš„ç–¼ç—›æ„Ÿè¦ºã€‚")

        # ============================================================
        # --- 3. ç—‡ç‹€æ¨¡å¼åˆ†æ ---
        # ============================================================
        st.markdown("---")
        st.markdown("#### ğŸ’¡ å‹•ä½œæ¨¡å¼èˆ‡ç—‡ç‹€äº¤å‰åˆ†æ")
        st.caption("ä»¥ä¸‹æ ¹æ“šæ‚¨çš„ç–¼ç—›éƒ¨ä½ã€ä¼´éš¨ç—‡ç‹€ã€èª˜ç™¼/ç·©è§£å› å­é€²è¡Œç¶œåˆåˆ¤è®€")

        # ----------------------------------------------------------
        # A. ç—‡ç‹€æ¨¡å¼åˆ†æ
        # ----------------------------------------------------------
        st.markdown("##### ğŸ§© A. ä¼´éš¨ç—‡ç‹€åˆ†æ")

        symptom_notes = []

        has_numbness_symptom = "ç„¡åŠ›" in symptoms  # from checkbox
        has_locking = "å¡ä½æ„Ÿ" in symptoms
        has_rom_loss = "è§’åº¦å—é™" in symptoms
        has_weakness = "ç„¡åŠ›" in symptoms

        # ç¥ç¶“å£“è¿«ï¼šæ•´åˆç–¼ç—›æ€§è³ª + ä¼´éš¨ç—‡ç‹€
        if has_nerve_pain and has_weakness:
            symptom_notes.append({
                "type": "nerve",
                "title": "ğŸ”¶ ç¥ç¶“å£“è¿«æ¨¡å¼ (Nerve Compression Pattern)",
                "detail": (
                    "æ‚¨çš„ç–¼ç—›æ€§è³ªæœ‰ **ç¥ç¶“ç‰¹å¾µ** (éº»ç—º/é‡åˆº)ï¼ŒåŠ ä¸Šä¼´éš¨ **ç„¡åŠ›æ„Ÿ**ï¼Œ"
                    "é€™æ˜¯å…¸å‹çš„ **ç¥ç¶“å—å£“è¿«** è¡¨ç¾ã€‚\n\n"
                    "- éº»ç—º/æ”¾å°„æ„Ÿ â†’ æ„Ÿè¦ºç¥ç¶“å—å½±éŸ¿\n"
                    "- ç„¡åŠ› â†’ é‹å‹•ç¥ç¶“ä¹Ÿå¯èƒ½å—åˆ°æ³¢åŠ\n"
                    "- è‹¥ç™¼ç”Ÿåœ¨ **é ¸éƒ¨â†’æ‰‹è‡‚**ï¼šå¯èƒ½æ¶‰åŠé ¸ç¥ç¶“æ ¹å£“è¿«\n"
                    "- è‹¥ç™¼ç”Ÿåœ¨ **è…°éƒ¨â†’è…¿éƒ¨**ï¼šå¯èƒ½æ¶‰åŠè…°æ¤ç¥ç¶“æ ¹å£“è¿«æˆ–åéª¨ç¥ç¶“å•é¡Œ\n\n"
                    "âš ï¸ **å»ºè­°**ï¼šé¿å…é•·æ™‚é–“å£“è¿«å§¿å‹¢ï¼Œç›¡æ—©å®‰æ’ç¥ç¶“å­¸æª¢æŸ¥ (EMG/NCV æˆ– MRI)ã€‚"
                ),
            })
        elif has_nerve_pain and not has_weakness:
            symptom_notes.append({
                "type": "nerve",
                "title": "ğŸ”¶ ç¥ç¶“åˆºæ¿€å¾µå…† (Nerve Irritation)",
                "detail": (
                    "æ‚¨çš„ç–¼ç—›æœ‰ **ç¥ç¶“æ€§ç‰¹å¾µ** (éº»ç—º/é‡åˆº)ï¼Œä½†ç›®å‰æœªä¼´éš¨æ˜é¡¯ç„¡åŠ›ã€‚\n\n"
                    "- é€™å¯èƒ½æ˜¯ç¥ç¶“å—åˆ° **è¼•åº¦å£“è¿«æˆ–åˆºæ¿€**\n"
                    "- å¸¸è¦‹åŸå› ï¼šæ¤é–“ç›¤çªå‡ºå£“è¿«ã€è‚Œè‚‰ç·Šç¹ƒå¡ä½ç¥ç¶“ã€è…•éš§é“ç—‡å€™ç¾¤\n"
                    "- âš ï¸ è‹¥éº»ç—ºç¯„åœæ“´å¤§æˆ–é–‹å§‹å‡ºç¾ç„¡åŠ›ï¼Œä»£è¡¨å£“è¿«ç¨‹åº¦å¯èƒ½åŠ é‡\n\n"
                    "ğŸ’¡ **å»ºè­°**ï¼šè¨˜éŒ„éº»ç—ºçš„ç¯„åœèˆ‡æ™‚é–“ï¼Œè‹¥æŒçºŒè¶…é2é€±æˆ–æƒ¡åŒ–ï¼Œå»ºè­°å°±é†«ã€‚"
                ),
            })
        elif has_weakness and not has_nerve_pain:
            symptom_notes.append({
                "type": "nerve",
                "title": "ğŸ”¶ è‚ŒåŠ›ä¸‹é™å¾µå…† (Muscle Weakness)",
                "detail": (
                    "æ‚¨æ„Ÿåˆ° **ç„¡åŠ›**ï¼Œä½†ç–¼ç—›æ€§è³ªæœªæ˜é¡¯åå‘ç¥ç¶“æ€§ã€‚å¯èƒ½çš„åŸå› ï¼š\n\n"
                    "- **ç–¼ç—›æŠ‘åˆ¶**ï¼šå› ç‚ºç—›ï¼Œå¤§è…¦è‡ªå‹•ã€Œé—œé–‰ã€è‚Œè‚‰å‡ºåŠ› (ä¿è­·æ©Ÿåˆ¶)\n"
                    "- **å»¢ç”¨æ€§èç¸®**ï¼šé•·æ™‚é–“ä¸æ´»å‹•å°è‡´è‚ŒåŠ›æµå¤±\n"
                    "- **è‚Œè…±æå‚·**ï¼šå¦‚æ—‹è½‰è‚Œç¾¤æ’•è£‚ã€è·Ÿè…±æå‚·\n\n"
                    "ğŸ’¡ **å»ºè­°**ï¼šè‹¥ç„¡åŠ›æ˜¯çªç„¶ç™¼ç”Ÿçš„ï¼Œå„ªå…ˆå°±é†«æ’é™¤ç¥ç¶“æˆ–è‚Œè…±æ–·è£‚ã€‚"
                ),
            })

        # é—œç¯€å•é¡Œï¼šæ•´åˆç–¼ç—›æ€§è³ª + ä¼´éš¨ç—‡ç‹€
        if has_locking and has_rom_loss:
            extra = ""
            if has_joint_pain:
                extra = "\n\nğŸ“Œ åˆä½µã€Œéˆç—›ã€çš„ç–¼ç—›æ€§è³ªï¼Œæ›´æ”¯æŒæ·±å±¤é—œç¯€çµæ§‹çš„å•é¡Œã€‚"
            symptom_notes.append({
                "type": "joint",
                "title": "ğŸŸ¢ é—œç¯€å…§éƒ¨éšœç¤™æ¨¡å¼ (Mechanical Block Pattern)",
                "detail": (
                    "æ‚¨åŒæ™‚æœ‰ **å¡ä½æ„Ÿ + è§’åº¦å—é™**ï¼Œæš—ç¤ºé—œç¯€å…§éƒ¨å¯èƒ½æœ‰æ©Ÿæ¢°æ€§é˜»æ“‹ã€‚\n\n"
                    "- å¯èƒ½åŸå› ï¼šåŠæœˆæ¿æå‚· (è†è“‹)ã€æ¸¸é›¢é«” (é—œç¯€å…§ç¢ç‰‡)ã€é—œç¯€å”‡æ’•è£‚ (è‚©è†€/é«–éƒ¨)\n"
                    "- ç‰¹å¾µï¼šåœ¨æŸå€‹è§’åº¦çªç„¶ã€Œå¡ä½ã€ï¼Œæœ‰æ™‚æœƒè‡ªå·±ã€Œå½ˆé–‹ã€\n"
                    f"{extra}\n\n"
                    "âš ï¸ **å»ºè­°**ï¼šé€™ç¨®æ¨¡å¼å–®é é‹å‹•é›£ä»¥è§£æ±ºï¼Œå»ºè­°å®‰æ’ MRI ç¢ºèªé—œç¯€å…§ç‹€æ³ã€‚"
                ),
            })
        elif has_locking:
            symptom_notes.append({
                "type": "joint",
                "title": "ğŸŸ¢ é—œç¯€å¡é–å¾µå…† (Joint Locking/Clicking)",
                "detail": (
                    "æ‚¨æœ‰ **å¡ä½æˆ–å½ˆéŸ¿æ„Ÿ**ï¼Œå¯èƒ½çš„åŸå› ï¼š\n\n"
                    "- é—œç¯€å…§å•é¡Œï¼šåŠæœˆæ¿ã€æ¸¸é›¢é«”ã€é—œç¯€å”‡æå‚·\n"
                    "- è‚Œè…±æ»‘å‹•ç•°å¸¸ï¼šè‚Œè…±åœ¨éª¨é ­ä¸Šå½ˆè·³ (å½ˆéŸ¿é«–ã€æ¿æ©ŸæŒ‡)\n"
                    "- æ°£æ³¡é‡‹æ”¾ï¼šé—œç¯€æ¶²ä¸­æ°£æ³¡ç ´è£‚ (é€šå¸¸ç„¡å®³)\n\n"
                    "ğŸ’¡ **å»ºè­°**ï¼šè‹¥ä¼´éš¨ **ç–¼ç—›æˆ–è…«è„¹** å»ºè­°å°±é†«ï¼›åƒ…æœ‰è²éŸ¿ä½†ä¸ç—›ï¼Œé€šå¸¸å•é¡Œè¼ƒå°ã€‚"
                ),
            })
        elif has_rom_loss:
            extra = ""
            if has_muscle_pain:
                extra = "\n\nğŸ“Œ åˆä½µã€Œç·Šç¹ƒ/é…¸ç—›ã€çš„ç–¼ç—›æ€§è³ªï¼Œä¿è­·æ€§è‚Œè‚‰ç—™æ”£çš„å¯èƒ½æ€§è¼ƒé«˜ã€‚"
            symptom_notes.append({
                "type": "joint",
                "title": "ğŸŸ¢ æ´»å‹•åº¦å—é™ (Range of Motion Loss)",
                "detail": (
                    "æ‚¨æœ‰ **è§’åº¦ä¸Šä¸å»/æ´»å‹•å—é™** çš„ç‹€æ³ï¼Œå¯èƒ½åŸå› ï¼š\n\n"
                    "- é—œç¯€å›Šç·Šç¸®ï¼šå¦‚äº”åè‚© (å†°å‡è‚©) çš„å…¸å‹è¡¨ç¾\n"
                    "- è‚Œè‚‰ç·Šç¹ƒ/ä¿è­·æ€§ç—™æ”£ï¼šèº«é«”å› ç–¼ç—›è€Œè‡ªå‹•ã€Œé–ä½ã€\n"
                    "- é—œç¯€é€€åŒ–ï¼šéª¨åˆºæˆ–è»Ÿéª¨ç£¨æå°è‡´æ´»å‹•ç©ºé–“æ¸›å°‘\n"
                    f"{extra}\n\n"
                    "ğŸ’¡ **å»ºè­°**ï¼šå€åˆ†æ˜¯ã€Œæƒ³å‹•ä½†ç—›æ‰€ä»¥ä¸æ•¢å‹•ã€é‚„æ˜¯ã€Œå®Œå…¨å‹•ä¸äº†ã€å¾ˆé‡è¦ã€‚"
                ),
            })

        # Display symptom analysis
        if symptom_notes:
            for sn in symptom_notes:
                box_class = {"nerve": "nerve-box", "joint": "joint-box", "muscle": "muscle-box"}.get(sn["type"], "pattern-box")
                st.markdown(f'<div class="{box_class}"><b>{sn["title"]}</b></div>', unsafe_allow_html=True)
                st.markdown(sn["detail"])
                st.write("")
        else:
            st.info("â„¹ï¸ æ‚¨æœªå‹¾é¸æ˜é¡¯çš„ä¼´éš¨ç—‡ç‹€ï¼Œç›®å‰è¼ƒç„¡æ³•åˆ¤æ–·ç‰¹å®šçš„ç—‡ç‹€æ¨¡å¼ã€‚")

        # ----------------------------------------------------------
        # B. å‹•ä½œæ¨¡å¼åˆ†æ
        # ----------------------------------------------------------
        st.markdown("##### ğŸƒ B. å‹•ä½œæ¨¡å¼åˆ†æ")

        movement_notes = []

        # === æ€¥æ€§ç™¼ç‚ ===
        if "ä¸å‹•ä¹Ÿç—›" in triggers or "ä¸€å‹•å°±ç—›" in triggers:
            detail = (
                "**ç‰¹å¾µ**ï¼šç„¡è«–å‹•æˆ–ä¸å‹•éƒ½ä¸èˆ’æœï¼Œå…¸å‹çš„æ€¥æ€§ç™¼ç‚æœŸè¡¨ç¾ã€‚\n\n"
                "**å»ºè­°**ï¼šä»¥ã€Œä¼‘æ¯ã€æ¶ˆç‚ã€é¿å…ç–¼ç—›å‹•ä½œã€ç‚ºå„ªå…ˆã€‚"
            )
            if "å†°æ•·" in relievers:
                detail += "\n\nâœ… å†°æ•·æœ‰æ•ˆï¼Œé€²ä¸€æ­¥æ”¯æŒæ€¥æ€§ç™¼ç‚éšæ®µã€‚"
            if has_inflam_pain:
                detail += "\n\nğŸ”´ åˆä½µç¼ç†±æ„Ÿçš„ç–¼ç—›æ€§è³ªï¼Œç™¼ç‚å¾µè±¡æ›´ç‚ºæ˜é¡¯ã€‚"
            if "å½±éŸ¿ç¡çœ " in impacts:
                detail += "\n\nâš ï¸ å·²å½±éŸ¿ç¡çœ ï¼Œç™¼ç‚ç¨‹åº¦å¯èƒ½è¼ƒåš´é‡ï¼Œå»ºè­°è€ƒæ…®å°±é†«ã€‚"
            movement_notes.append(("inflam-box", "ğŸ”´ æ€¥æ€§ç™¼ç‚æœŸ (Acute Inflammatory Phase)", detail))

        # === å±ˆæ›²ä¸è€å— ===
        flexion_triggers = [t for t in triggers if t in ["ä¹…å", "å½è…°"]]
        if flexion_triggers:
            detail = (
                f"**èª˜ç™¼å› å­**ï¼š{'ã€'.join(flexion_triggers)}\n\n"
                "**åˆ¤è®€**ï¼šå‰å½/ä¹…åæœƒåŠ åŠ‡ç–¼ç—›ï¼Œå¸¸è¦‹æ–¼æ¤é–“ç›¤ç›¸é—œå•é¡Œæˆ–å§¿å‹¢æ€§è…°ç—›ã€‚\n\n"
                "**å»ºè­°**ï¼šä½¿ç”¨è…°é ã€æ¯30åˆ†é˜èµ·èº«æ´»å‹•ã€é¿å…åæ²™ç™¼æˆ–ä½çŸ®æ¤…å­ã€‚"
            )
            if "èµ°è·¯/æ´»å‹•å¾Œ" in relievers:
                detail += "\n\nâœ… èµ°è·¯èƒ½ç·©è§£ï¼Œæ›´æ”¯æŒå±ˆæ›²ä¸è€å—çš„åˆ¤æ–·ã€‚"
            if has_nerve_pain and ("è…°" in pain_location or "èƒŒ" in pain_location):
                detail += "\n\nâš ï¸ åˆä½µç¥ç¶“æ€§ç–¼ç—› (éº»ç—º/æ”¾å°„)ï¼Œéœ€æ³¨æ„æ˜¯å¦æœ‰æ¤é–“ç›¤çªå‡ºå£“è¿«ç¥ç¶“ã€‚"
            movement_notes.append(("pattern-box", "ğŸ”¸ å±ˆæ›²ä¸è€å— (Flexion Intolerance)", detail))

        # === ä¼¸ç›´ä¸è€å— ===
        extension_triggers = [t for t in triggers if t in ["å¾Œä»°/æŒºèº«", "ä¹…ç«™"]]
        if extension_triggers:
            detail = (
                f"**èª˜ç™¼å› å­**ï¼š{'ã€'.join(extension_triggers)}\n\n"
                "**åˆ¤è®€**ï¼šå¾Œä»°/ä¹…ç«™æœƒåŠ åŠ‡ç–¼ç—›ï¼Œå¸¸è¦‹æ–¼è„Šæ¤å°é¢é—œç¯€ã€æ¤ç®¡ç‹¹çª„æˆ–è„Šæ¤æ»‘è„«ã€‚\n\n"
                "**å»ºè­°**ï¼šé¿å…é•·æ™‚é–“ç«™ç«‹æˆ–å¾Œä»°ï¼Œèµ°è·¯æ™‚å¾®å¾®æ”¶å°è…¹ã€‚"
            )
            if "ä¼‘æ¯/ä¸æ´»å‹•" in relievers:
                detail += "\n\nâœ… ä¼‘æ¯èƒ½ç·©è§£ï¼Œæ”¯æŒçµæ§‹æ€§å£“è¿«çš„å¯èƒ½ã€‚"
            if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                detail += "\n\nğŸ“Œ æ‚¨çš„å¹´é½¡å±¤è¼ƒæ˜“æœ‰é€€åŒ–æ€§è„Šæ¤å•é¡Œï¼Œå»ºè­°å®‰æ’å½±åƒæª¢æŸ¥ã€‚"
            if has_joint_pain:
                detail += "\n\nğŸ“Œ åˆä½µéˆç—›çš„ç–¼ç—›æ€§è³ªï¼Œå°é¢é—œç¯€é€€åŒ–æˆ–æ¤ç®¡ç‹¹çª„çš„å¯èƒ½æ€§ä¸Šå‡ã€‚"
            movement_notes.append(("pattern-box", "ğŸ”¸ ä¼¸ç›´ä¸è€å— (Extension Intolerance)", detail))

        # === æ··åˆæ¨¡å¼ ===
        if flexion_triggers and extension_triggers:
            movement_notes.append(("inflam-box", "ğŸ”´ æ··åˆæ¨¡å¼ (Mixed Pattern)", (
                "**åˆ¤è®€**ï¼šå½æ›²å’Œä¼¸ç›´éƒ½æœƒå¼•ç™¼ç–¼ç—›ï¼Œå¯èƒ½ä¸åªä¸€å€‹çµæ§‹å—å½±éŸ¿ã€‚\n\n"
                "**å»ºè­°**ï¼šç¶­æŒè„Šæ¤ä¸­ç«‹ä½ç½®ç‚ºä¸»ï¼Œé¿å…æ¥µç«¯è§’åº¦ï¼Œå°‹æ±‚å°ˆæ¥­é¢å°é¢è©•ä¼°ã€‚"
            )))

        # === æ‰¿é‡æ¨¡å¼ (è†è“‹) ===
        stair_triggers = [t for t in triggers if t in ["ä¸Šæ¨“æ¢¯", "ä¸‹æ¨“æ¢¯"]]
        if stair_triggers:
            detail = f"**èª˜ç™¼å› å­**ï¼š{'ã€'.join(stair_triggers)}\n\n"
            if "ä¸‹æ¨“æ¢¯" in stair_triggers and "ä¸Šæ¨“æ¢¯" not in stair_triggers:
                detail += "**åˆ¤è®€**ï¼šä¸‹æ¨“æ¢¯ (é›¢å¿ƒæ”¶ç¸®) æ¯”ä¸Šæ¨“æ›´ç—›ï¼Œå¸¸è¦‹æ–¼é«•éª¨è‚¡éª¨ç–¼ç—›ç—‡å€™ç¾¤ã€é«•éª¨è‚Œè…±ç‚ã€‚"
            elif "ä¸Šæ¨“æ¢¯" in stair_triggers and "ä¸‹æ¨“æ¢¯" not in stair_triggers:
                detail += "**åˆ¤è®€**ï¼šä¸Šæ¨“æ¢¯ (å‘å¿ƒæ”¶ç¸®) æ¯”è¼ƒç—›ï¼Œå¸¸è¦‹æ–¼è‚¡å››é ­è‚Œè‚ŒåŠ›ä¸è¶³ã€é«•éª¨è»Œè·¡ç•°å¸¸ã€‚"
            else:
                detail += "**åˆ¤è®€**ï¼šä¸Šä¸‹æ¨“æ¢¯éƒ½ç—›ï¼Œè†é—œç¯€æ‰¿é‡èƒ½åŠ›æ˜é¡¯ä¸‹é™ã€‚"
            if has_locking:
                detail += "\n\nâš ï¸ åˆä½µå¡ä½æ„Ÿï¼Œéœ€æ³¨æ„åŠæœˆæ¿æˆ–æ¸¸é›¢é«”çš„å¯èƒ½ã€‚"
            if has_weakness:
                detail += "\n\nâš ï¸ åˆä½µç„¡åŠ›æ„Ÿï¼Œéœ€åŠ å¼·è‚¡å››é ­è‚Œèˆ‡è‡€è‚Œè¨“ç·´ã€‚"
            if has_joint_pain:
                detail += "\n\nğŸ“Œ åˆä½µéˆç—›ï¼Œå¯èƒ½æ¶‰åŠè»Ÿéª¨ç£¨æç­‰é€€åŒ–æ€§å•é¡Œã€‚"
            detail += "\n\n**å»ºè­°**ï¼šæš«æ™‚æ¸›å°‘æ¨“æ¢¯ä½¿ç”¨ï¼Œè€ƒæ…®å¾åå§¿ä¼¸è†ã€é ç‰†åŠè¹²ç­‰ä½è² è·è¨“ç·´é–‹å§‹ã€‚"
            movement_notes.append(("pattern-box", "ğŸ”¸ æ‰¿é‡æ¨¡å¼ç•°å¸¸ (Weight-Bearing Pattern)", detail))

        # === è‚©è†€ä¸Šèˆ‰ ===
        if "æ‰‹èˆ‰é«˜" in triggers:
            detail = "**åˆ¤è®€**ï¼šæ‰‹èˆ‰éé ­ç–¼ç—›ï¼Œå¯èƒ½æ¶‰åŠè‚©å¤¾æ“ ç—‡å€™ç¾¤æˆ–æ—‹è½‰è‚Œç¾¤å•é¡Œã€‚\n\n"
            if "è‚©è†€" in pain_location:
                detail += "éƒ¨ä½ç‚ºè‚©è†€ï¼Œæ›´æ”¯æŒæ—‹è½‰è‚Œç¾¤æå‚·ã€è‚©å³°ä¸‹æ»‘å›Šç‚æˆ–è‚©èƒ›æ§åˆ¶ä¸è‰¯ã€‚"
            if has_weakness:
                detail += "\n\nâš ï¸ åˆä½µç„¡åŠ›æ„Ÿï¼Œéœ€æ³¨æ„æ—‹è½‰è‚Œç¾¤å¯èƒ½æœ‰æ’•è£‚ã€‚"
            if "å½±éŸ¿ç¡çœ " in impacts:
                detail += "\n\nâš ï¸ å·²å½±éŸ¿ç¡çœ  (å°¤å…¶å´ç¡)ï¼Œå¸¸è¦‹æ–¼æ—‹è½‰è‚Œç¾¤æå‚·ã€‚"
            if has_muscle_pain:
                detail += "\n\nğŸ“Œ åˆä½µç·Šç¹ƒ/é…¸ç—›ï¼Œè‚©é ¸è‚Œç¾¤ä»£å„Ÿæ€§ç·Šç¹ƒä¹Ÿéœ€è™•ç†ã€‚"
            detail += "\n\n**å»ºè­°**ï¼šæš«æ™‚é¿å…æ‰‹èˆ‰éè‚©å‹•ä½œï¼Œå…ˆå¼·åŒ–è‚©èƒ›ç©©å®šè‚Œç¾¤ã€‚"
            movement_notes.append(("pattern-box", "ğŸ”¸ ä¸Šèˆ‰å—é™ (Overhead Pattern)", detail))

        # === æ—‹è½‰ä¸è€å— ===
        if "è½‰èº«/è½‰å½" in triggers:
            detail = (
                "**åˆ¤è®€**ï¼šè½‰èº«æˆ–è½‰å½æ™‚ç–¼ç—›ï¼Œå¯èƒ½æ¶‰åŠè„Šæ¤æ—‹è½‰çµæ§‹æˆ–æ ¸å¿ƒç©©å®šä¸è¶³ã€‚\n\n"
                "**å»ºè­°**ï¼šè½‰èº«æ™‚ä»¥ã€Œæ•´å€‹èº«é«”ä¸€èµ·è½‰ã€å–ä»£ã€Œåªè½‰è…°ã€ï¼ŒåŠ å¼·æ ¸å¿ƒæŠ—æ—‹è½‰è¨“ç·´ã€‚"
            )
            movement_notes.append(("pattern-box", "ğŸ”¸ æ—‹è½‰ä¸è€å— (Rotation Intolerance)", detail))

        # === è¡Œèµ°æ¨¡å¼ ===
        if "èµ°è·¯" in triggers:
            detail = "**åˆ¤è®€**ï¼šèµ°è·¯æœƒå¼•ç™¼ç–¼ç—›ï¼Œå¯èƒ½åŸå› ä¾éƒ¨ä½ä¸åŒï¼š\n\n"
            if "è…³è¸" in pain_location or "è¶³éƒ¨" in pain_location:
                detail += "- è¶³è¸ï¼šè¶³åº•ç­‹è†œç‚ã€è·Ÿè…±ç‚ã€è¸é—œç¯€ä¸ç©©å®š\n"
            elif "è†" in pain_location:
                detail += "- è†è“‹ï¼šè»Ÿéª¨ç£¨æã€æ‰¿é‡è»¸ç·šç•°å¸¸\n"
            elif "è…°" in pain_location or "èƒŒ" in pain_location:
                detail += "- è…°æ¤ï¼šæ¤ç®¡ç‹¹çª„ (èµ°ä¸€æ®µå°±è¦ä¼‘æ¯)ã€è„Šæ¤ä¸ç©©å®š\n"
            elif "é«–" in pain_location:
                detail += "- é«–éƒ¨ï¼šé«–é—œç¯€é€€åŒ–ã€å½ˆéŸ¿é«–ã€è‡€ä¸­è‚Œç„¡åŠ›\n"
            else:
                detail += "- å»ºè­°é‡å°å…·é«”éƒ¨ä½é€²ä¸€æ­¥è©•ä¼°\n"
            if has_nerve_pain and ("è…°" in pain_location or "èƒŒ" in pain_location):
                detail += "\nâš ï¸ åˆä½µç¥ç¶“æ€§ç–¼ç—› + èµ°è·¯åŠ åŠ‡ + è…°æ¤ï¼Œéœ€è€ƒæ…®æ¤ç®¡ç‹¹çª„çš„å¯èƒ½ (é–“æ­‡æ€§è·›è¡Œ)ã€‚"
            movement_notes.append(("pattern-box", "ğŸ”¸ æ­¥è¡Œç–¼ç—› (Gait-Related Pain)", detail))

        # Display movement analysis
        if movement_notes:
            for box_class, title, detail in movement_notes:
                st.markdown(f'<div class="{box_class}"><b>{title}</b></div>', unsafe_allow_html=True)
                st.markdown(detail)
                st.write("")
        else:
            st.info("â„¹ï¸ æ‚¨æœªé¸æ“‡æ˜é¡¯çš„èª˜ç™¼å› å­ï¼Œå»ºè­°ç”±ç‰©ç†æ²»ç™‚å¸«é€²è¡Œç¾å ´å‹•ä½œè©•ä¼°ã€‚")

        # ----------------------------------------------------------
        # C. ç·©è§£å› å­åˆ†æ
        # ----------------------------------------------------------
        st.markdown("##### ğŸŒ¡ï¸ C. ç·©è§£å› å­åˆ†æ")

        relief_notes = []

        if "ç†±æ•·" in relievers and "å†°æ•·" in relievers:
            relief_notes.append(
                "ğŸ”¹ **ç†±æ•·èˆ‡å†°æ•·éƒ½æœ‰æ•ˆ**ï¼šæ‚£è™•å¯èƒ½åŒæ™‚æœ‰è‚Œè‚‰ç·Šç¹ƒ (ç†±æ•·) å’Œè¼•å¾®ç™¼ç‚ (å†°æ•·)ã€‚"
                "å»ºè­°æ€¥æ€§æœŸå…ˆå†°æ•·ï¼Œæ…¢æ€§æœŸä»¥ç†±æ•·ç‚ºä¸»ã€‚"
            )
        elif "ç†±æ•·" in relievers:
            note = "ğŸ”¹ **ç†±æ•·æœ‰æ•ˆ**ï¼šé¡¯ç¤ºè‚Œè‚‰ç·Šç¹ƒã€è¡€æ¶²å¾ªç’°ä¸è‰¯å¯èƒ½æ˜¯ä¸»è¦å•é¡Œã€‚"
            if has_muscle_pain:
                note += " åˆä½µæ‚¨çš„ç·Šç¹ƒ/é…¸ç—›ç–¼ç—›æ€§è³ªï¼Œè‚Œç­‹è†œå•é¡Œçš„å¯èƒ½æ€§è¼ƒé«˜ï¼Œé©åˆé…åˆä¼¸å±•é‹å‹•ã€‚"
            relief_notes.append(note)
        elif "å†°æ•·" in relievers:
            note = "ğŸ”¹ **å†°æ•·æœ‰æ•ˆ**ï¼šç›®å‰æ‚£è™•å¯èƒ½ä»æœ‰æ€¥æ€§ç™¼ç‚æˆ–è…«è„¹ã€‚æ¯æ¬¡å†°æ•·15-20åˆ†é˜ã€‚"
            if has_inflam_pain:
                note += " åˆä½µç¼ç†±æ„Ÿçš„ç–¼ç—›æ€§è³ªï¼Œç™¼ç‚åæ‡‰è¼ƒæ˜ç¢ºã€‚"
            relief_notes.append(note)

        if "èµ°è·¯/æ´»å‹•å¾Œ" in relievers:
            detail = "ğŸ”¹ **æ´»å‹•å¾Œç·©è§£**ï¼šå‹•ä¸€å‹•åè€Œæ¯”è¼ƒèˆ’æœï¼Œ"
            if "ä¹…å" in triggers or "ä¹…ç«™" in triggers:
                detail += "çµåˆä¹…å/ä¹…ç«™èª˜ç™¼çš„ç‰¹å¾µï¼Œé€™æ˜¯å…¸å‹çš„ã€Œè¶Šä¸å‹•è¶Šç—›ã€æ¨¡å¼ã€‚å»ºè­°è¦å¾‹æ´»å‹•ã€‚"
            else:
                detail += "ä»£è¡¨æ´»å‹•æœ‰åŠ©æ–¼å¢åŠ å¾ªç’°å’Œé—œç¯€æ½¤æ»‘ã€‚"
            if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                detail += "\nğŸ“Œ ä¸­è€å¹´æ—ç¾¤çš„ã€Œæ™¨åƒµã€ç¾è±¡ä¹Ÿå±¬æ­¤é¡ã€‚"
            if has_joint_pain:
                detail += "\nğŸ“Œ åˆä½µéˆç—› + æ´»å‹•å¾Œæ”¹å–„ï¼Œé€€åŒ–æ€§é—œç¯€ç‚çš„æ¨¡å¼å€¼å¾—æ³¨æ„ã€‚"
            relief_notes.append(detail)

        if "æ”¹è®Šå§¿å‹¢" in relievers:
            relief_notes.append("ğŸ”¹ **æ”¹è®Šå§¿å‹¢æœ‰æ•ˆ**ï¼šç–¼ç—›èˆ‡ç‰¹å®šå§¿å‹¢é«˜åº¦ç›¸é—œã€‚å»ºè­°æ‰¾å‡ºæœ€èˆ’é©å§¿å‹¢ä¸¦é¿å…ç¶­æŒç–¼ç—›å§¿å‹¢ã€‚")

        if "ä¼‘æ¯/ä¸æ´»å‹•" in relievers and "èµ°è·¯/æ´»å‹•å¾Œ" not in relievers:
            relief_notes.append("ğŸ”¹ **ä¼‘æ¯æœ‰æ•ˆä½†æ´»å‹•æœªæ”¹å–„**ï¼šæ‚£è™•å¯èƒ½ä»åœ¨ç™¼ç‚éšæ®µï¼Œè² è·æœƒåŠ é‡ç—‡ç‹€ã€‚ä»¥ã€Œç›¸å°ä¼‘æ¯ã€ç‚ºä¸»ä½†éå®Œå…¨ä¸å‹•ã€‚")

        if "æ²’æœ‰æ”¹å–„" in relievers:
            note = "ğŸ”´ **ä»»ä½•æ–¹å¼éƒ½ç„¡æ³•æ”¹å–„**ï¼šç–¼ç—›ä¾†æºå¯èƒ½è¼ƒè¤‡é›œã€‚"
            if has_nerve_pain:
                note += " åˆä½µç¥ç¶“æ€§ç–¼ç—›ç‰¹å¾µï¼Œå¯èƒ½éœ€è¦é‡å°ç¥ç¶“æœ¬èº«é€²è¡Œæ²»ç™‚ã€‚"
            note += " **å¼·çƒˆå»ºè­°å°‹æ±‚å°ˆæ¥­è©•ä¼°ã€‚**"
            relief_notes.append(note)

        if relief_notes:
            for rn in relief_notes:
                st.markdown(rn)
                st.write("")
        else:
            st.info("â„¹ï¸ æ‚¨æœªé¸æ“‡ç·©è§£å› å­ï¼Œå»ºè­°å˜—è©¦è¨˜éŒ„ä»€éº¼ç‹€æ³ä¸‹ç—‡ç‹€æœƒæ¸›è¼•ã€‚")

        # ----------------------------------------------------------
        # D. åŠŸèƒ½å½±éŸ¿è©•ä¼°
        # ----------------------------------------------------------
        if impacts:
            st.markdown("##### âš¡ D. åŠŸèƒ½å½±éŸ¿è©•ä¼°")

            if "å½±éŸ¿ç¡çœ " in impacts:
                note = "ğŸ”¸ **ç¡çœ å—å½±éŸ¿**ï¼šå¤œé–“ç—›æˆ–ç„¡æ³•æ‰¾åˆ°èˆ’é©ç¡å§¿ï¼Œä»£è¡¨å•é¡Œå¯èƒ½è¼ƒåš´é‡ã€‚"
                if has_inflam_pain:
                    note += " åˆä½µç¼ç†±æ„Ÿï¼Œå¤œé–“ç™¼ç‚åæ‡‰å¯èƒ½è¼ƒå¼·ã€‚"
                st.markdown(note)
            if "å¤±å»å¹³è¡¡" in impacts:
                note = "ğŸ”¸ **å¹³è¡¡/è·Œå€’é¢¨éšª**ï¼šå¤±å»å¹³è¡¡æ˜¯é‡è¦çš„å®‰å…¨è­¦è¨Šã€‚"
                if has_nerve_pain:
                    note += "\nâš ï¸ åˆä½µç¥ç¶“æ€§ç–¼ç—› + å¤±å»å¹³è¡¡ï¼Œéœ€ç‰¹åˆ¥æ³¨æ„ **è„Šé«“å£“è¿« (Myelopathy)** çš„å¯èƒ½ï¼Œå»ºè­°å„˜é€Ÿå°±é†«ã€‚"
                st.markdown(note)
            if "éœ€è—¥ç‰©æ­¢ç—›" in impacts:
                st.markdown("ğŸ”¸ **éœ€è—¥ç‰©æ§åˆ¶**ï¼šé•·æœŸä¾è³´æ­¢ç—›è—¥å¯èƒ½æ©è“‹çœŸæ­£å•é¡Œã€‚å»ºè­°æ­é…ç‰©ç†æ²»ç™‚æ‰¾å‡ºæ ¹æœ¬åŸå› ã€‚")
            if "å½±éŸ¿æ—¥å¸¸" in impacts:
                st.markdown("ğŸ”¸ **æ—¥å¸¸åŠŸèƒ½å—é™**ï¼šåŸºæœ¬æ´»å‹•å—å½±éŸ¿ï¼Œå»ºè­°ç©æ¥µå°‹æ±‚æ²»ç™‚ä»‹å…¥ã€‚")

        # === çµå°¾å»ºè­° ===
        st.markdown("---")
        st.subheader("ğŸ“Œ å»ºè­°ä¸‹ä¸€æ­¥")

        if has_red_flags:
            st.error("ğŸš¨ **ç«‹å³å°±é†«**ï¼šæ‚¨æœ‰ç´…æ——è­¦è¨Šï¼Œå»ºè­°å„˜é€Ÿå°±é†«é€²è¡Œè©³ç´°æª¢æŸ¥ã€‚")
        elif vas_score >= 7:
            st.warning("âš ï¸ **å»ºè­°å°±é†«**ï¼šé›–ç„¡ç´…æ——è­¦è¨Šï¼Œä½†ç–¼ç—›æŒ‡æ•¸è¼ƒé«˜ï¼Œå»ºè­°ç›¡å¿«å°±é†«æˆ–æ¥å—ç‰©ç†æ²»ç™‚è©•ä¼°ã€‚")
        elif vas_score >= 4:
            st.info("ğŸ’¡ **å»ºè­°è¿½è¹¤**ï¼šä¸­åº¦ç–¼ç—›ï¼Œå»ºè­°å®‰æ’ç‰©ç†æ²»ç™‚å¸«é€²è¡Œå®Œæ•´è©•ä¼°ï¼Œä¸¦æ³¨æ„å‹•ä½œæ¨¡å¼èª¿æ•´ã€‚")
        else:
            st.success("ğŸ‘ **æŒçºŒè§€å¯Ÿ**ï¼šç›®å‰ç–¼ç—›ç¨‹åº¦è¼ƒè¼•ï¼Œå¯å…ˆé€éè¡›æ•™èˆ‡è‡ªæˆ‘ç®¡ç†æ”¹å–„ï¼Œè‹¥æŒçºŒä¸é©å†å°±é†«ã€‚")

        st.caption("âš ï¸ æœ¬å ±å‘Šåƒ…ä¾›è¡›æ•™åƒè€ƒï¼Œä¸å¯å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚å¦‚æœ‰ç–‘æ…®è«‹è«®è©¢é†«å¸«æˆ–ç‰©ç†æ²»ç™‚å¸«ã€‚")
        st.caption("ğŸ“ æœ¬å ±å‘Šå¯æˆªåœ–ä¿å­˜ï¼Œä¸¦æ”œå¸¶è‡³å°±è¨ºæ™‚æä¾›çµ¦é†«ç™‚äººå“¡åƒè€ƒã€‚")