import streamlit as st

# è¨­å®šé é¢é…ç½®
st.set_page_config(
    page_title="1åˆ†é˜éª¨éª¼ç—›ç—‡ç¯©æª¢",
    page_icon="ğŸ¦´",
    layout="centered"
)

# è‡ªè¨‚ CSS
st.markdown("""
    <style>
    .main-header {
        font-size: 22px;
        font-weight: bold;
        color: #1a1a2e;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #2E86C1;
    }
    .subtitle {
        font-size: 17px;
        font-weight: 500;
        color: #666;
        margin-top: -15px;
        margin-bottom: 20px;
        letter-spacing: 0.5px;
    }
    .danger-box {
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #dc3545;
        color: #721c24;
        margin-bottom: 15px;
    }
    .pattern-box {
        background-color: #e8f4f8;
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 4px solid #2E86C1;
        margin-bottom: 10px;
        font-weight: 600;
        color: #1a1a2e;
    }
    .nerve-box {
        background-color: #fff3e0;
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 4px solid #e65100;
        margin-bottom: 10px;
        font-weight: 600;
        color: #1a1a2e;
    }
    .joint-box {
        background-color: #e8f5e9;
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 4px solid #2e7d32;
        margin-bottom: 10px;
        font-weight: 600;
        color: #1a1a2e;
    }
    .inflam-box {
        background-color: #fce4ec;
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 4px solid #c62828;
        margin-bottom: 10px;
        font-weight: 600;
        color: #1a1a2e;
    }
    .muscle-box {
        background-color: #e3f2fd;
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 4px solid #1565c0;
        margin-bottom: 10px;
        font-weight: 600;
        color: #1a1a2e;
    }
    .pain-chip {
        display: inline-block;
        padding: 4px 12px;
        margin: 3px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
    }
    .chip-nerve { background-color: #fff3e0; border: 1px solid #e65100; color: #bf360c; }
    .chip-muscle { background-color: #e3f2fd; border: 1px solid #1565c0; color: #0d47a1; }
    .chip-inflam { background-color: #fce4ec; border: 1px solid #c62828; color: #b71c1c; }
    .chip-joint { background-color: #e8f5e9; border: 1px solid #2e7d32; color: #1b5e20; }
    .chip-neutral { background-color: #f5f5f5; border: 1px solid #9e9e9e; color: #424242; }
    .section-label {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-top: 10px;
        margin-bottom: 5px;
    }
    .stCheckbox label { font-size: 15px; }
    </style>
    """, unsafe_allow_html=True)

# --- æ¨™é¡Œå€åŸŸ ---
st.title("éª¨éª¼è‚Œè‚‰ç—›ç—‡ â€” 1 åˆ†é˜å¿«é€Ÿç¯©æª¢")
st.markdown('<div class="subtitle">Musculoskeletal Quick Screening System</div>', unsafe_allow_html=True)
st.write("è«‹ä¾ç…§æ‚¨çš„å¯¦éš›ç‹€æ³å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œç³»çµ±å°‡ä¾æ“šè‡¨åºŠé‚è¼¯å”åŠ©åˆæ­¥è©•ä¼°ã€‚")
st.markdown("---")

# --- å…è²¬è²æ˜ ---
st.warning(
    "**å…è²¬è²æ˜ï½œDisclaimer**ã€€"
    "æœ¬å ±å‘Šåƒ…ä¾›è¡›æ•™ç”¨é€”èˆ‡åˆæ­¥åƒè€ƒï¼Œä¸å¯å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚"
    "è‹¥æ‚¨æ„Ÿåˆ°åŠ‡çƒˆä¸é©æˆ–å‡ºç¾ç‰¹å®šå¾µå…†ï¼Œè«‹å‹™å¿…è«®è©¢å°ˆç§‘é†«å¸«æˆ–ç‰©ç†æ²»ç™‚å¸«é€²è¡Œå¯¦é«”è‡¨åºŠè©•ä¼°ã€‚"
)

if "report_generated" not in st.session_state:
    st.session_state.report_generated = False

# --- è¡¨å–®é–‹å§‹ ---
with st.form("intake_form"):

    # === 1. åŸºæœ¬è³‡æ–™ ===
    st.markdown('<div class="main-header">1. åŸºæœ¬è³‡æ–™</div>', unsafe_allow_html=True)
    c1, c2 = st.columns(2)
    with c1:
        gender = st.selectbox("ç”Ÿç†æ€§åˆ¥", ["è«‹é¸æ“‡", "ç”·", "å¥³"], index=0)
    with c2:
        age = st.selectbox("å¹´é½¡å€é–“", [
            "18æ­²ä»¥ä¸‹", "19-30æ­²", "31-45æ­²", "46-60æ­²", "60æ­²ä»¥ä¸Š"
        ], index=2)

    occupation = st.selectbox("è·æ¥­é¡å‹", [
        "éœæ…‹ä¹…åé¡ (è¾¦å…¬å®¤/å¸æ©Ÿ)",
        "å‹åŠ›å·¥ä½œé¡ (æ¬é‹/å·¥åœ°)",
        "ä¹…ç«™æœå‹™é¡ (å°ˆæ«ƒ/é¤é£²)",
        "å®¶å‹™æ“æŒ",
        "é‹å‹•å“¡/æ•™ç·´",
        "é€€ä¼‘/å…¶ä»–"
    ])

    # === 2. æ‚£è™•å®šä½ ===
    st.markdown('<div class="main-header">2. æ‚£è™•å®šä½</div>', unsafe_allow_html=True)
    pain_location = st.selectbox("ä¸»è¦ç–¼ç—›ä½ç½®", [
        "-- è«‹é¸æ“‡ --", "é ¸æ¤/é ­éƒ¨", "è‚©è†€/ä¸Šè‚¢", "è…°æ¤/ä¸‹èƒŒ",
        "é«–éƒ¨/éª¨ç›†", "è†è“‹", "è…³è¸/è¶³éƒ¨", "å…¶ä»–"
    ])
    vas_score = st.slider("ç›®å‰ç–¼ç—›åˆ†æ•¸ï¼ˆVAS: 0 = ä¸ç—›ï¼Œ10 = åŠ‡ç—›ï¼‰", 0, 10, 5)

    # === 3. ç–¼ç—›æ€§è³ª ===
    st.markdown('<div class="main-header">3. ç–¼ç—›æ€§è³ª</div>', unsafe_allow_html=True)
    st.caption("ä¸åŒçš„ç–¼ç—›æ„Ÿè¦ºå¯èƒ½æš—ç¤ºä¸åŒçš„çµ„ç¹”ä¾†æºï¼Œè«‹é¸æ“‡æœ€ç¬¦åˆæ‚¨æ„Ÿå—çš„æè¿°")

    pain_quality = st.multiselect(
        "æ‚¨çš„ç–¼ç—›æ„Ÿè¦ºæœ€æ¥è¿‘å“ªäº›ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰",
        options=[
            "éº»ç—º / æ”¾å°„æ„Ÿ â€” åƒé›»æµç«„éã€å»¶ä¼¸åˆ°é ç«¯",
            "é‡åˆºç—› â€” åƒè¢«é‡æ‰ã€åˆºåˆºçš„",
            "éˆç—› â€” æ‚¶æ‚¶çš„ã€æ·±å±¤çš„ä¸èˆ’æœ",
            "ç¼ç†±æ„Ÿ â€” åƒç‡’ç‡™ã€ç†±è¾£è¾£çš„",
            "ç·Šç¹ƒ / æ‹‰æ‰¯æ„Ÿ â€” åƒè¢«æ‹‰ä½ã€ç¹ƒä½",
            "é…¸ç—› â€” åƒé‹å‹•å¾Œçš„ç— ã€ä½¿ä¸ä¸ŠåŠ›",
            "æŒ‰å£“ç—› â€” å£“ä¸‹å»æ‰ç—›ã€æœ‰æ˜ç¢ºç—›é»",
        ]
    )

    # === 4. ç´…æ——è­¦è¨Š ===
    st.markdown('<div class="main-header">4. å±éšªå¾µå…†ç¯©æª¢ï¼ˆRed Flagsï¼‰</div>', unsafe_allow_html=True)
    st.info("ä»¥ä¸‹é …ç›®ç”¨æ–¼æ’é™¤éœ€è¦ç«‹å³å°±é†«çš„ç‹€æ³ï¼Œè«‹æ“šå¯¦å‹¾é¸ã€‚")

    selected_red_flags = st.multiselect(
        "è‹¥ç„¡ä¸‹åˆ—ç—‡ç‹€ï¼Œè«‹é¸æ“‡ã€Œçš†æ²’æœ‰ã€ï¼š",
        options=[
            "çš†æ²’æœ‰",
            "å¤§å°ä¾¿æ§åˆ¶å•é¡Œï¼ˆå¤±ç¦æˆ–æ’å°¿å›°é›£ï¼‰",
            "è¿‘æœŸä¸æ˜åŸå› é«”é‡å¿«é€Ÿæ¸›è¼•",
            "ä¼´éš¨ç™¼ç‡’ã€ç•å¯’æˆ–åš´é‡å¤œé–“ç—›ï¼ˆç—›åˆ°é†’ä¾†ï¼‰",
            "åš´é‡å¤–å‚· / è·Œå€’å¾Œæ‰å‡ºç¾çš„ç–¼ç—›",
            "éœæ­¢ä¸å‹•æ™‚ä»åŠ‡çƒˆç–¼ç—›ï¼ˆRest Painï¼‰",
            "é›™å´è‚¢é«”åŒæ™‚å‡ºç¾éº»æœ¨æˆ–ç„¡åŠ›",
            "èƒ¸ç—›ä¼´éš¨å‘¼å¸å›°é›£"
        ],
        default=["çš†æ²’æœ‰"]
    )

    # === 5. ä¼´éš¨ç—‡ç‹€èˆ‡åŠŸèƒ½å½±éŸ¿ ===
    st.markdown('<div class="main-header">5. ä¼´éš¨ç—‡ç‹€èˆ‡åŠŸèƒ½å½±éŸ¿</div>', unsafe_allow_html=True)

    col_s1, col_s2 = st.columns(2)
    with col_s1:
        st.markdown('<div class="section-label">ä¼´éš¨ç—‡ç‹€ï¼ˆå¯è¤‡é¸ï¼‰</div>', unsafe_allow_html=True)
        symptoms = []
        if st.checkbox("æ„Ÿåˆ°ç„¡åŠ›ï¼ˆWeaknessï¼‰"): symptoms.append("ç„¡åŠ›")
        if st.checkbox("æ„Ÿè¦ºå¡ä½ï¼ˆLocking / Clickingï¼‰"): symptoms.append("å¡ä½æ„Ÿ")
        if st.checkbox("æ´»å‹•è§’åº¦å—é™ï¼ˆROM Lossï¼‰"): symptoms.append("è§’åº¦å—é™")
    with col_s2:
        st.markdown('<div class="section-label">åŠŸèƒ½å½±éŸ¿ï¼ˆå¯è¤‡é¸ï¼‰</div>', unsafe_allow_html=True)
        impacts = []
        if st.checkbox("å½±éŸ¿æ—¥å¸¸æ´»å‹•ï¼ˆç©¿è¡£/å·¥ä½œï¼‰"): impacts.append("å½±éŸ¿æ—¥å¸¸")
        if st.checkbox("å½±éŸ¿ç¡çœ ï¼ˆSleep Disturbanceï¼‰"): impacts.append("å½±éŸ¿ç¡çœ ")
        if st.checkbox("éœ€è¦è—¥ç‰©æ­¢ç—›"): impacts.append("éœ€è—¥ç‰©æ­¢ç—›")
        if st.checkbox("å®¹æ˜“å¤±å»å¹³è¡¡ / è·Œå€’"): impacts.append("å¤±å»å¹³è¡¡")

    # === 6. å‹•ä½œæ¨¡å¼æª¢æ¸¬ ===
    st.markdown('<div class="main-header">6. å‹•ä½œæ¨¡å¼æª¢æ¸¬</div>', unsafe_allow_html=True)

    st.markdown('<div class="section-label">ä»€éº¼æƒ…æ³æœƒè®“ç–¼ç—›åŠ åŠ‡ï¼Ÿï¼ˆèª˜ç™¼å› å­ï¼‰</div>', unsafe_allow_html=True)
    triggers = st.multiselect("å¯è¤‡é¸", [
        "ä¹…å", "ä¹…ç«™", "èµ°è·¯", "ä¸Šæ¨“æ¢¯", "ä¸‹æ¨“æ¢¯",
        "è½‰èº« / è½‰å½", "ä¸€å‹•å°±ç—›", "ä¸å‹•ä¹Ÿç—›",
        "å½è…°", "å¾Œä»° / æŒºèº«", "æ‰‹èˆ‰é«˜"
    ], key="triggers")

    st.markdown('<div class="section-label">ä»€éº¼æ–¹å¼èƒ½è®“ç–¼ç—›ç·©è§£ï¼Ÿï¼ˆç·©è§£å› å­ï¼‰</div>', unsafe_allow_html=True)
    relievers = st.multiselect("å¯è¤‡é¸", [
        "ä¼‘æ¯ / ä¸æ´»å‹•", "ç†±æ•·", "å†°æ•·", "æ”¹è®Šå§¿å‹¢",
        "æ™šä¸Šè¼ƒæ¸›ç·©", "èµ°è·¯ / æ´»å‹•å¾Œæ”¹å–„", "æ²’æœ‰ä»»ä½•æ”¹å–„"
    ], key="relievers")

    st.markdown("---")
    submit_btn = st.form_submit_button("ç”¢ç”Ÿè©•ä¼°å ±å‘Š", use_container_width=True)


# === è§£æç–¼ç—›æ€§è³ª ===
def parse_pain_quality(pq_list):
    tags = {"nerve": [], "muscle": [], "inflam": [], "joint": []}
    for pq in pq_list:
        if "éº»ç—º" in pq or "æ”¾å°„" in pq:
            tags["nerve"].append("éº»ç—º/æ”¾å°„æ„Ÿ")
        if "é‡åˆº" in pq:
            tags["nerve"].append("é‡åˆºç—›")
        if "éˆç—›" in pq:
            tags["joint"].append("éˆç—›")
        if "ç¼ç†±" in pq:
            tags["inflam"].append("ç¼ç†±æ„Ÿ")
        if "ç·Šç¹ƒ" in pq or "æ‹‰æ‰¯" in pq:
            tags["muscle"].append("ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ")
        if "é…¸ç—›" in pq:
            tags["muscle"].append("é…¸ç—›")
        if "æŒ‰å£“" in pq:
            tags["muscle"].append("æŒ‰å£“ç—›")
    return tags


# === å ±å‘Šç”Ÿæˆ ===
if submit_btn:
    errors = []
    if gender == "è«‹é¸æ“‡":
        errors.append("è«‹é¸æ“‡ç”Ÿç†æ€§åˆ¥")
    if pain_location == "-- è«‹é¸æ“‡ --":
        errors.append("è«‹é¸æ“‡ç–¼ç—›éƒ¨ä½")
    if errors:
        for e in errors:
            st.error(e)
    else:
        st.session_state.report_generated = True

        # Red flags
        has_red_flags = False
        valid_red_flags = []
        if "çš†æ²’æœ‰" in selected_red_flags and len(selected_red_flags) > 1:
            valid_red_flags = [x for x in selected_red_flags if x != "çš†æ²’æœ‰"]
            has_red_flags = True
        elif "çš†æ²’æœ‰" not in selected_red_flags and selected_red_flags:
            valid_red_flags = selected_red_flags
            has_red_flags = True

        # Pain quality
        pain_tags = parse_pain_quality(pain_quality)
        has_nerve_pain = len(pain_tags["nerve"]) > 0
        has_muscle_pain = len(pain_tags["muscle"]) > 0
        has_inflam_pain = len(pain_tags["inflam"]) > 0
        has_joint_pain = len(pain_tags["joint"]) > 0

        # Symptom flags
        has_weakness = "ç„¡åŠ›" in symptoms
        has_locking = "å¡ä½æ„Ÿ" in symptoms
        has_rom_loss = "è§’åº¦å—é™" in symptoms

        # ===================== å ±å‘Šé–‹å§‹ =====================
        st.markdown("---")
        st.markdown("## ç¯©æª¢è©•ä¼°å ±å‘Š")
        st.markdown('<div class="subtitle">Screening Assessment Report</div>', unsafe_allow_html=True)

        # --- Red Flags ---
        if has_red_flags:
            st.markdown(f"""
            <div class="danger-box">
                <b>ç´…æ——è­¦è¨Šï¼ˆRed Flagsï¼‰â€” æª¢æ¸¬åˆ°å±éšªå¾µå…†</b><br><br>
                æ‚¨å‹¾é¸äº†ä»¥ä¸‹é …ç›®ï¼š
                <ul>{''.join([f'<li>{f}</li>' for f in valid_red_flags])}</ul>
                <b>è‡¨åºŠå»ºè­°ï¼š</b>ä¸Šè¿°ç—‡ç‹€å¯èƒ½ä»£è¡¨è¼ƒåš´é‡çš„ç—…ç†å•é¡Œï¼ˆç¥ç¶“å£“è¿«ã€æ„ŸæŸ“ã€éª¨æŠ˜ç­‰ï¼‰ï¼Œ
                è«‹å‹¿åƒ…ä¾è³´é‹å‹•æˆ–è‡ªæˆ‘è™•ç†ï¼Œå»ºè­°å„˜é€Ÿå‰å¾€é†«ç™‚é™¢æ‰€æ¥å—å°ˆç§‘æª¢æŸ¥ã€‚
            </div>
            """, unsafe_allow_html=True)
        else:
            st.success("ç´…æ——è­¦è¨Šç¯©æª¢ï¼šæœªç™¼ç¾éœ€ç«‹å³å°±é†«çš„å±éšªå¾µå…†")

        # --- æ‘˜è¦ ---
        st.markdown("#### åŸºæœ¬è³‡è¨Š")
        m1, m2, m3 = st.columns(3)
        with m1:
            st.metric("æ€§åˆ¥", gender)
        with m2:
            st.metric("å¹´é½¡", age)
        with m3:
            st.metric("VAS ç–¼ç—›æŒ‡æ•¸", f"{vas_score} / 10")

        rc1, rc2 = st.columns(2)
        with rc1:
            st.write(f"**éƒ¨ä½ï¼š** {pain_location}")
            st.write(f"**è·æ¥­ï¼š** {occupation}")
            st.write(f"**ä¼´éš¨ç—‡ç‹€ï¼š** {'ã€'.join(symptoms) if symptoms else 'ç„¡'}")
        with rc2:
            st.write(f"**åŠŸèƒ½å½±éŸ¿ï¼š** {'ã€'.join(impacts) if impacts else 'å°šå¯'}")
            st.write(f"**èª˜ç™¼å› å­ï¼š** {'ã€'.join(triggers) if triggers else 'æœªé¸æ“‡'}")
            st.write(f"**ç·©è§£å› å­ï¼š** {'ã€'.join(relievers) if relievers else 'æœªé¸æ“‡'}")

        # === ç–¼ç—›æ€§è³ªåˆ†æ ===
        st.markdown("---")
        st.markdown("#### ç–¼ç—›æ€§è³ªåˆ†æ")

        if pain_quality:
            chip_map = {
                "éº»ç—º/æ”¾å°„æ„Ÿ": "chip-nerve", "é‡åˆºç—›": "chip-nerve",
                "éˆç—›": "chip-joint", "ç¼ç†±æ„Ÿ": "chip-inflam",
                "ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ": "chip-muscle", "é…¸ç—›": "chip-muscle",
                "æŒ‰å£“ç—›": "chip-muscle",
            }
            chips_html = ""
            for pq in pain_quality:
                short = pq.split("â€”")[0].strip()
                css = "chip-neutral"
                for k, v in chip_map.items():
                    if k in short:
                        css = v
                        break
                chips_html += f'<span class="pain-chip {css}">{short}</span>'
            st.markdown(f"**æ‰€é¸ç–¼ç—›æ€§è³ªï¼š** {chips_html}", unsafe_allow_html=True)
            st.write("")

            pain_interp = []

            # --- ç¥ç¶“æ€§ ---
            if has_nerve_pain:
                items = pain_tags["nerve"]
                if "éº»ç—º/æ”¾å°„æ„Ÿ" in items and "é‡åˆºç—›" in items:
                    d = (
                        "åŒæ™‚å‡ºç¾éº»ç—ºæ”¾å°„æ„Ÿèˆ‡é‡åˆºç—›ï¼Œé«˜åº¦æç¤º **ç¥ç¶“æ€§ç–¼ç—›ï¼ˆNeuropathic Painï¼‰**ã€‚\n\n"
                        "- æ”¾å°„æ„Ÿä»£è¡¨ç–¼ç—›æ²¿ç¥ç¶“èµ°å‘å‚³å°ï¼ˆå¦‚è…°â†’è‡€â†’è…¿ï¼Œæˆ–é ¸â†’è‚©â†’æ‰‹ï¼‰\n"
                        "- é‡åˆºç—›ç‚ºç¥ç¶“å—åˆºæ¿€çš„å…¸å‹è¡¨ç¾\n"
                        "- å¸¸è¦‹ç—…å› ï¼šæ¤é–“ç›¤çªå‡ºã€ç¥ç¶“æ ¹ç—…è®Šã€å‘¨é‚Šç¥ç¶“å¡å£“\n\n"
                        "**å»ºè­°ï¼š** ç´€éŒ„éº»ç—ºçš„å»¶ä¼¸ç¯„åœï¼Œå°±é†«æ™‚å¯æä¾›ä½œç‚ºè¨ºæ–·ä¾æ“šã€‚"
                    )
                elif "éº»ç—º/æ”¾å°„æ„Ÿ" in items:
                    d = (
                        "å‡ºç¾éº»ç—ºæˆ–æ”¾å°„æ„Ÿï¼Œç–¼ç—›å¯èƒ½å¾ä¸€å€‹é»å»¶ä¼¸è‡³é ç«¯ã€‚\n\n"
                        "- é€šå¸¸ä»£è¡¨ç¥ç¶“å—åˆ°å£“è¿«æˆ–åˆºæ¿€\n"
                        "- å¸¸è¦‹æ¨¡å¼ï¼šè…°ç—›æ”¾å°„è‡³è…¿ï¼ˆåéª¨ç¥ç¶“ï¼‰ã€é ¸ç—›æ”¾å°„è‡³æ‰‹ï¼ˆé ¸ç¥ç¶“æ ¹ï¼‰\n"
                        "- è‹¥æ”¾å°„ç¯„åœé€æ¼¸æ“´å¤§ï¼Œä»£è¡¨å£“è¿«å¯èƒ½åŠ é‡\n\n"
                        "**å»ºè­°ï¼š** é¿å…åŠ é‡æ”¾å°„æ„Ÿçš„å§¿å‹¢ï¼Œç›¡æ—©å®‰æ’ç¥ç¶“å­¸è©•ä¼°ã€‚"
                    )
                else:
                    d = (
                        "å‡ºç¾é‡åˆºç—›ï¼Œå¯èƒ½ç‚ºå°çº–ç¶­ç¥ç¶“å—åˆºæ¿€çš„è¡¨ç¾ã€‚\n\n"
                        "- å¸¸è¦‹æ–¼ç¥ç¶“å¡å£“åˆæœŸã€ä»£è¬æ€§ç¥ç¶“ç—…è®Š\n"
                        "- è‹¥æŒçºŒè¶…é 2 é€±ä¸”ç¯„åœæ“´å¤§ï¼Œå»ºè­°å®‰æ’ç¥ç¶“å‚³å°æª¢æŸ¥ã€‚"
                    )
                pain_interp.append(("nerve-box", "ç¥ç¶“æ€§ç–¼ç—›ç‰¹å¾µï¼ˆNeuropathic Featuresï¼‰", d))

            # --- è‚Œè‚‰ç­‹è†œ ---
            if has_muscle_pain:
                items = pain_tags["muscle"]
                if "æŒ‰å£“ç—›" in items and ("ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ" in items or "é…¸ç—›" in items):
                    d = (
                        "åŒæ™‚æœ‰æŒ‰å£“ç—›èˆ‡ç·Šç¹ƒ / é…¸ç—›ï¼Œç¬¦åˆ **è‚Œç­‹è†œç–¼ç—›ï¼ˆMyofascial Painï¼‰** çš„ç‰¹å¾µã€‚\n\n"
                        "- æŒ‰å£“ç—›ä»£è¡¨æœ‰æ˜ç¢ºçš„å£“ç—›é»ï¼ˆTrigger Pointï¼‰\n"
                        "- ç·Šç¹ƒ / é…¸ç—›ä»£è¡¨è‚Œè‚‰é•·æœŸè™•æ–¼ç·Šå¼µæˆ–éåº¦ä½¿ç”¨ç‹€æ…‹\n"
                        "- å¸¸è¦‹æ–¼ï¼šè‚©é ¸ç— ç—›ã€è…°èƒŒè‚Œç­‹è†œç‚ã€è‚Œè…±é™„è‘—é»å•é¡Œ\n\n"
                        "**é å¾Œï¼š** è‚Œç­‹è†œå•é¡Œé€šå¸¸å°ç‰©ç†æ²»ç™‚åæ‡‰è‰¯å¥½ã€‚\n"
                        "**å»ºè­°ï¼š** ç†±æ•·ï¼‹ä¼¸å±•ï¼‹å£“ç—›é»æ”¾é¬†ï¼Œä¸¦èª¿æ•´é€ æˆç·Šç¹ƒçš„å§¿å‹¢ã€‚"
                    )
                elif "æŒ‰å£“ç—›" in items:
                    d = (
                        "æœ‰æ˜ç¢ºçš„å±€éƒ¨æŒ‰å£“ç—›ï¼Œå¯èƒ½ç‚ºè‚Œç­‹è†œè§¸ç™¼é»æˆ–è‚Œè…± / éŸŒå¸¶é™„è‘—è™•ç™¼ç‚ã€‚\n\n"
                        "- è‹¥ç—›é»éå¸¸ç²¾ç¢ºï¼ˆä¸€æŒ‡å¯æŒ‡å‡ºï¼‰ï¼Œæ›´å‚¾å‘å±€éƒ¨è»Ÿçµ„ç¹”å•é¡Œ\n\n"
                        "**å»ºè­°ï¼š** å˜—è©¦è¼•æŸ”çš„æŒ‰å£“æ”¾é¬†æˆ–æ»¾ç­’æ”¾é¬†ã€‚"
                    )
                elif "ç·Šç¹ƒ/æ‹‰æ‰¯æ„Ÿ" in items:
                    d = (
                        "å‡ºç¾ç·Šç¹ƒæˆ–æ‹‰æ‰¯æ„Ÿï¼Œå¸¸è¦‹æ–¼é•·æ™‚é–“å§¿å‹¢ä¸è‰¯æˆ–è‚Œè‚‰éåº¦ä½¿ç”¨ã€‚\n\n"
                        "**å»ºè­°ï¼š** é©åº¦ä¼¸å±•ã€ç†±æ•·ã€å§¿å‹¢èª¿æ•´é€šå¸¸èƒ½æœ‰æ•ˆç·©è§£ã€‚"
                    )
                elif "é…¸ç—›" in items:
                    d = (
                        "å‡ºç¾é…¸ç—›æ„Ÿï¼Œå¯èƒ½ç‚ºè‚Œè‚‰éåº¦ä½¿ç”¨æˆ–æ…¢æ€§ç–²å‹ã€‚\n\n"
                        "- è‹¥é…¸ç—›åœ¨æ´»å‹•å¾ŒåŠ åŠ‡ä½†ä¼‘æ¯æœƒæ”¹å–„ï¼Œå‚¾å‘è‚Œè‚‰è² è·å•é¡Œ\n"
                        "- è‹¥æŒçºŒä¸é€€ï¼Œéœ€è€ƒæ…®è‚Œè‚‰æœ¬èº«çš„ç—…è®Š\n\n"
                        "**å»ºè­°ï¼š** é©åº¦æ´»å‹•ï¼‹å……è¶³ä¼‘æ¯ï¼Œé¿å…çªç„¶å¤§å¹…å¢åŠ é‹å‹•é‡ã€‚"
                    )
                else:
                    d = ""
                if d:
                    pain_interp.append(("muscle-box", "è‚Œè‚‰ / ç­‹è†œç–¼ç—›ç‰¹å¾µï¼ˆMyofascial Featuresï¼‰", d))

            # --- ç™¼ç‚ ---
            if has_inflam_pain:
                d = (
                    "å‡ºç¾ç¼ç†±æ„Ÿï¼Œå¯èƒ½ä»£è¡¨ï¼š\n\n"
                    "- **æ€¥æ€§ç™¼ç‚åæ‡‰ï¼š** çµ„ç¹”å—å‚·å¾Œçš„ç´…ã€è…«ã€ç†±ã€ç—›\n"
                    "- **ç¥ç¶“æ€§ç¼ç†±ï¼š** ç¥ç¶“å—æç”¢ç”Ÿçš„ç¼ç‡’æ„Ÿï¼ˆå¦‚ CRPSï¼‰\n"
                    "- **åŒ–å­¸æ€§åˆºæ¿€ï¼š** è‚Œè…±ç‚ã€æ»‘å›Šç‚ç­‰ç™¼ç‚ä»‹è³ªåˆºæ¿€å‘¨é‚Šçµ„ç¹”\n\n"
                )
                if has_nerve_pain:
                    d += "åˆä½µç¥ç¶“æ€§ç—‡ç‹€ï¼Œéœ€æ³¨æ„æ˜¯å¦ç‚ºç¥ç¶“æ€§ç¼ç†±ç—›ï¼ˆBurning Neuropathic Painï¼‰ï¼Œå»ºè­°å°±é†«è©•ä¼°ã€‚\n\n"
                d += "**å»ºè­°ï¼š** æ€¥æ€§æœŸå¯å˜—è©¦å†°æ•·é™æº«ï¼›è‹¥ç¼ç†±æ„ŸæŒçºŒè¶…é 2 é€±ï¼Œå»ºè­°å°±é†«ã€‚"
                pain_interp.append(("inflam-box", "ç™¼ç‚ / ç¼ç†±ç‰¹å¾µï¼ˆInflammatory Featuresï¼‰", d))

            # --- é—œç¯€ / æ·±å±¤ ---
            if has_joint_pain:
                d = (
                    "å‡ºç¾éˆç—›ï¼Œä¸€ç¨®æ‚¶æ‚¶çš„ã€æ·±å±¤çš„ä¸é©æ„Ÿã€‚\n\n"
                    "- éˆç—›é€šå¸¸ä¾†è‡ªè¼ƒæ·±å±¤çš„çµæ§‹ï¼šé—œç¯€ã€éª¨éª¼ã€æ·±å±¤è‚Œè‚‰\n"
                    "- å¸¸è¦‹æ–¼é€€åŒ–æ€§é—œç¯€ç‚ã€æ¤é–“ç›¤å•é¡Œã€éª¨å…§å£“åŠ›è®ŠåŒ–\n"
                )
                if has_locking:
                    d += "\nåˆä½µã€Œå¡ä½æ„Ÿã€ï¼Œæ›´æ”¯æŒé—œç¯€å…§éƒ¨çµæ§‹ï¼ˆå¦‚åŠæœˆæ¿ã€é—œç¯€å”‡ï¼‰çš„å•é¡Œã€‚"
                if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                    d += "\næ‚¨çš„å¹´é½¡å±¤è¼ƒå®¹æ˜“å‡ºç¾é€€åŒ–æ€§è®ŠåŒ–ï¼Œéˆç—›å¯èƒ½èˆ‡è»Ÿéª¨ç£¨ææˆ–éª¨è³ªè®ŠåŒ–æœ‰é—œã€‚"
                d += "\n\n**å»ºè­°ï¼š** éˆç—›è‹¥æŒçºŒä¸”é€æ¼¸åŠ é‡ï¼Œå»ºè­°å®‰æ’ X å…‰æˆ– MRI æª¢æŸ¥ã€‚"
                pain_interp.append(("joint-box", "æ·±å±¤ / é—œç¯€æ€§ç–¼ç—›ç‰¹å¾µï¼ˆDeep / Articular Featuresï¼‰", d))

            # --- æ··åˆæ¨¡å¼ ---
            if has_nerve_pain and has_muscle_pain:
                pain_interp.append(("pattern-box", "æ··åˆæ¨¡å¼ï¼šç¥ç¶“ï¼‹è‚Œè‚‰ï¼ˆMixed Patternï¼‰", (
                    "åŒæ™‚æœ‰ç¥ç¶“æ€§èˆ‡è‚Œè‚‰æ€§çš„ç–¼ç—›ç‰¹å¾µï¼Œè‡¨åºŠä¸Šç›¸ç•¶å¸¸è¦‹ã€‚\n\n"
                    "- å¸¸è¦‹æƒ…å¢ƒï¼šç¥ç¶“å£“è¿«å¾Œï¼Œå‘¨é‚Šè‚Œè‚‰ä¿è­·æ€§æ”¶ç¸®ï¼Œå°è‡´äºŒæ¬¡æ€§è‚Œè‚‰ç–¼ç—›\n"
                    "- ä¾‹å¦‚ï¼šæ¤é–“ç›¤å£“è¿«ç¥ç¶“ï¼ˆéº»ç—ºæ”¾å°„ï¼‰ï¼‹ è…°éƒ¨è‚Œè‚‰ç—™æ”£ï¼ˆç·Šç¹ƒé…¸ç—›ï¼‰\n\n"
                    "**å»ºè­°ï¼š** æ²»ç™‚æ™‚éœ€åŒæ™‚è™•ç†ç¥ç¶“å£“è¿«èˆ‡è‚Œè‚‰ç·Šç¹ƒï¼Œå–®ç¨è™•ç†å…¶ä¸­ä¸€å€‹æ•ˆæœå¯èƒ½æœ‰é™ã€‚"
                )))
            if has_nerve_pain and has_inflam_pain:
                pain_interp.append(("nerve-box", "æ··åˆæ¨¡å¼ï¼šç¥ç¶“ï¼‹ç™¼ç‚ï¼ˆNeuro-Inflammatoryï¼‰", (
                    "åŒæ™‚æœ‰ç¥ç¶“æ€§èˆ‡ç™¼ç‚æ€§çš„ç–¼ç—›ç‰¹å¾µã€‚\n\n"
                    "- å¯èƒ½ä»£è¡¨ç¥ç¶“æœ¬èº«æ­£åœ¨ç™¼ç‚ï¼ˆNeuritisï¼‰ï¼Œæˆ–ç™¼ç‚ç‰©è³ªåˆºæ¿€é„°è¿‘ç¥ç¶“\n\n"
                    "**å»ºè­°ï¼š** é€™ç¨®çµ„åˆéœ€è¦ç©æ¥µè™•ç†ï¼Œå»ºè­°å°±é†«è©•ä¼°æ˜¯å¦éœ€è¦æ¶ˆç‚æ²»ç™‚ã€‚"
                )))

            for box_class, title, detail in pain_interp:
                st.markdown(f'<div class="{box_class}">{title}</div>', unsafe_allow_html=True)
                st.markdown(detail)
                st.write("")
        else:
            st.info("æœªé¸æ“‡ç–¼ç—›æ€§è³ªï¼Œæ­¤éƒ¨åˆ†ç„¡æ³•åˆ†æã€‚å»ºè­°å˜—è©¦æè¿°æ‚¨çš„ç–¼ç—›æ„Ÿè¦ºä»¥ç²å¾—æ›´å®Œæ•´çš„è©•ä¼°ã€‚")

        # ========================================
        # å‹•ä½œæ¨¡å¼èˆ‡ç—‡ç‹€äº¤å‰åˆ†æ
        # ========================================
        st.markdown("---")
        st.markdown("#### å‹•ä½œæ¨¡å¼èˆ‡ç—‡ç‹€äº¤å‰åˆ†æ")
        st.caption("æ ¹æ“šç–¼ç—›éƒ¨ä½ã€ä¼´éš¨ç—‡ç‹€ã€ç–¼ç—›æ€§è³ªã€èª˜ç™¼ / ç·©è§£å› å­é€²è¡Œç¶œåˆåˆ¤è®€")

        # --- A. ä¼´éš¨ç—‡ç‹€ ---
        st.markdown("##### A. ä¼´éš¨ç—‡ç‹€åˆ†æ")
        symptom_notes = []

        if has_nerve_pain and has_weakness:
            symptom_notes.append(("nerve-box",
                "ç¥ç¶“å£“è¿«æ¨¡å¼ï¼ˆNerve Compression Patternï¼‰",
                "ç–¼ç—›æ€§è³ªå…·ç¥ç¶“ç‰¹å¾µï¼ˆéº»ç—º / é‡åˆºï¼‰ï¼Œä¸”ä¼´éš¨ç„¡åŠ›æ„Ÿï¼Œç‚ºå…¸å‹çš„ç¥ç¶“å£“è¿«è¡¨ç¾ã€‚\n\n"
                "- æ„Ÿè¦ºç¥ç¶“å—å½±éŸ¿ â†’ éº»ç—º / æ”¾å°„\n"
                "- é‹å‹•ç¥ç¶“æ³¢åŠ â†’ ç„¡åŠ›\n"
                "- é ¸éƒ¨â†’æ‰‹è‡‚ï¼šé ¸ç¥ç¶“æ ¹å£“è¿«ã€€ï½œã€€è…°éƒ¨â†’è…¿éƒ¨ï¼šè…°æ¤ç¥ç¶“æ ¹å£“è¿« / åéª¨ç¥ç¶“\n\n"
                "**å»ºè­°ï¼š** é¿å…é•·æ™‚é–“å£“è¿«å§¿å‹¢ï¼Œç›¡æ—©å®‰æ’ç¥ç¶“å­¸æª¢æŸ¥ï¼ˆEMG / NCV æˆ– MRIï¼‰ã€‚"
            ))
        elif has_nerve_pain:
            symptom_notes.append(("nerve-box",
                "ç¥ç¶“åˆºæ¿€å¾µå…†ï¼ˆNerve Irritationï¼‰",
                "ç–¼ç—›å…·ç¥ç¶“æ€§ç‰¹å¾µä½†ç›®å‰æœªä¼´éš¨æ˜é¡¯ç„¡åŠ›ï¼Œå¯èƒ½ç‚ºè¼•åº¦å£“è¿«æˆ–åˆºæ¿€ã€‚\n\n"
                "- å¸¸è¦‹åŸå› ï¼šæ¤é–“ç›¤çªå‡ºã€è‚Œè‚‰ç·Šç¹ƒå¡ä½ç¥ç¶“ã€è…•éš§é“ç—‡å€™ç¾¤\n"
                "- è‹¥ç¯„åœæ“´å¤§æˆ–å‡ºç¾ç„¡åŠ›ï¼Œä»£è¡¨å£“è¿«å¯èƒ½åŠ é‡\n\n"
                "**å»ºè­°ï¼š** è¨˜éŒ„éº»ç—ºç¯„åœèˆ‡æŒçºŒæ™‚é–“ï¼Œè¶…é 2 é€±æˆ–æƒ¡åŒ–æ‡‰å°±é†«ã€‚"
            ))
        elif has_weakness:
            symptom_notes.append(("nerve-box",
                "è‚ŒåŠ›ä¸‹é™å¾µå…†ï¼ˆMuscle Weaknessï¼‰",
                "æœ‰ç„¡åŠ›æ„Ÿä½†ç–¼ç—›æ€§è³ªæœªæ˜é¡¯åå‘ç¥ç¶“æ€§ï¼Œå¯èƒ½åŸå› ï¼š\n\n"
                "- ç–¼ç—›æŠ‘åˆ¶ï¼šå› ç–¼ç—›å¤§è…¦è‡ªå‹•é™åˆ¶å‡ºåŠ›ï¼ˆä¿è­·æ©Ÿåˆ¶ï¼‰\n"
                "- å»¢ç”¨æ€§èç¸®ï¼šé•·æ™‚é–“ä¸æ´»å‹•å°è‡´è‚ŒåŠ›æµå¤±\n"
                "- è‚Œè…±æå‚·ï¼šå¦‚æ—‹è½‰è‚Œç¾¤æ’•è£‚ã€è·Ÿè…±æå‚·\n\n"
                "**å»ºè­°ï¼š** è‹¥ç„¡åŠ›ç‚ºçªç„¶ç™¼ç”Ÿï¼Œå„ªå…ˆå°±é†«æ’é™¤ç¥ç¶“æˆ–è‚Œè…±æ–·è£‚ã€‚"
            ))

        if has_locking and has_rom_loss:
            extra = ""
            if has_joint_pain:
                extra = "\n\nåˆä½µéˆç—›çš„ç–¼ç—›æ€§è³ªï¼Œæ›´æ”¯æŒæ·±å±¤é—œç¯€çµæ§‹çš„å•é¡Œã€‚"
            symptom_notes.append(("joint-box",
                "é—œç¯€å…§éƒ¨éšœç¤™æ¨¡å¼ï¼ˆMechanical Block Patternï¼‰",
                f"åŒæ™‚æœ‰å¡ä½æ„Ÿèˆ‡è§’åº¦å—é™ï¼Œæš—ç¤ºé—œç¯€å…§éƒ¨å¯èƒ½æœ‰æ©Ÿæ¢°æ€§é˜»æ“‹ã€‚\n\n"
                "- å¯èƒ½åŸå› ï¼šåŠæœˆæ¿æå‚·ã€é—œç¯€å…§æ¸¸é›¢é«”ã€é—œç¯€å”‡æ’•è£‚\n"
                f"- ç‰¹å¾µï¼šåœ¨æŸå€‹è§’åº¦çªç„¶å¡ä½ï¼Œæœ‰æ™‚æœƒè‡ªå·±å½ˆé–‹{extra}\n\n"
                "**å»ºè­°ï¼š** æ­¤æ¨¡å¼å–®é é‹å‹•é›£ä»¥è§£æ±ºï¼Œå»ºè­°å®‰æ’ MRI ç¢ºèªé—œç¯€å…§ç‹€æ³ã€‚"
            ))
        elif has_locking:
            symptom_notes.append(("joint-box",
                "é—œç¯€å¡é–å¾µå…†ï¼ˆJoint Locking / Clickingï¼‰",
                "æœ‰å¡ä½æˆ–å½ˆéŸ¿æ„Ÿï¼Œå¯èƒ½åŸå› ï¼š\n\n"
                "- é—œç¯€å…§å•é¡Œï¼šåŠæœˆæ¿ã€æ¸¸é›¢é«”ã€é—œç¯€å”‡\n"
                "- è‚Œè…±æ»‘å‹•ç•°å¸¸ï¼šè‚Œè…±åœ¨éª¨çªä¸Šå½ˆè·³ï¼ˆå½ˆéŸ¿é«–ã€æ¿æ©ŸæŒ‡ï¼‰\n"
                "- æ°£æ³¡é‡‹æ”¾ï¼šé—œç¯€æ¶²æ°£æ³¡ç ´è£‚ï¼ˆé€šå¸¸ç„¡å®³ï¼‰\n\n"
                "**å»ºè­°ï¼š** è‹¥ä¼´éš¨ç–¼ç—›æˆ–è…«è„¹å»ºè­°å°±é†«ï¼›åƒ…æœ‰è²éŸ¿ä½†ä¸ç—›é€šå¸¸å•é¡Œè¼ƒå°ã€‚"
            ))
        elif has_rom_loss:
            extra = ""
            if has_muscle_pain:
                extra = "\n\nåˆä½µç·Šç¹ƒ / é…¸ç—›çš„ç–¼ç—›æ€§è³ªï¼Œä¿è­·æ€§è‚Œè‚‰ç—™æ”£çš„å¯èƒ½æ€§è¼ƒé«˜ã€‚"
            symptom_notes.append(("joint-box",
                "æ´»å‹•åº¦å—é™ï¼ˆRange of Motion Lossï¼‰",
                f"è§’åº¦ä¸Šä¸å»æˆ–æ´»å‹•å—é™ï¼Œå¯èƒ½åŸå› ï¼š\n\n"
                "- é—œç¯€å›Šç·Šç¸®ï¼šå¦‚äº”åè‚©ï¼ˆå†°å‡è‚©ï¼‰\n"
                "- ä¿è­·æ€§ç—™æ”£ï¼šèº«é«”å› ç–¼ç—›è‡ªå‹•é™åˆ¶å‹•ä½œ\n"
                f"- é—œç¯€é€€åŒ–ï¼šéª¨åˆºæˆ–è»Ÿéª¨ç£¨æ{extra}\n\n"
                "**å»ºè­°ï¼š** å€åˆ†ã€Œæƒ³å‹•ä½†ç—›æ‰€ä»¥ä¸æ•¢å‹•ã€èˆ‡ã€Œå®Œå…¨å‹•ä¸äº†ã€å¾ˆé‡è¦ï¼Œå‰è€…å¤šç‚ºè‚Œè‚‰ä¿è­·ï¼Œå¾Œè€…å¯èƒ½ç‚ºçµæ§‹å•é¡Œã€‚"
            ))

        if symptom_notes:
            for box_cls, title, detail in symptom_notes:
                st.markdown(f'<div class="{box_cls}">{title}</div>', unsafe_allow_html=True)
                st.markdown(detail)
                st.write("")
        else:
            st.info("æœªå‹¾é¸æ˜é¡¯ä¼´éš¨ç—‡ç‹€ï¼Œç„¡æ³•é€²è¡Œç—‡ç‹€æ¨¡å¼åˆ¤è®€ã€‚")

        # --- B. å‹•ä½œæ¨¡å¼ ---
        st.markdown("##### B. å‹•ä½œæ¨¡å¼åˆ†æ")
        movement_notes = []

        # æ€¥æ€§ç™¼ç‚
        if "ä¸å‹•ä¹Ÿç—›" in triggers or "ä¸€å‹•å°±ç—›" in triggers:
            d = "ç„¡è«–å‹•æˆ–ä¸å‹•éƒ½ä¸èˆ’æœï¼Œç‚ºå…¸å‹æ€¥æ€§ç™¼ç‚æœŸè¡¨ç¾ã€‚å»ºè­°ä»¥ä¼‘æ¯ã€æ¶ˆç‚ã€é¿å…ç–¼ç—›å‹•ä½œç‚ºå„ªå…ˆã€‚"
            if "å†°æ•·" in relievers:
                d += "\n\nå†°æ•·æœ‰æ•ˆï¼Œé€²ä¸€æ­¥æ”¯æŒæ€¥æ€§ç™¼ç‚éšæ®µçš„åˆ¤æ–·ã€‚"
            if has_inflam_pain:
                d += "\n\nåˆä½µç¼ç†±æ„Ÿçš„ç–¼ç—›æ€§è³ªï¼Œç™¼ç‚å¾µè±¡æ›´ç‚ºæ˜é¡¯ã€‚"
            if "å½±éŸ¿ç¡çœ " in impacts:
                d += "\n\nå·²å½±éŸ¿ç¡çœ ï¼Œç™¼ç‚ç¨‹åº¦å¯èƒ½è¼ƒåš´é‡ï¼Œå»ºè­°è€ƒæ…®å°±é†«æ§åˆ¶ã€‚"
            movement_notes.append(("inflam-box", "æ€¥æ€§ç™¼ç‚æœŸï¼ˆAcute Inflammatory Phaseï¼‰", d))

        # å±ˆæ›²ä¸è€å—
        flex = [t for t in triggers if t in ["ä¹…å", "å½è…°"]]
        if flex:
            d = (
                f"èª˜ç™¼å› å­ï¼š{'ã€'.join(flex)}\n\n"
                "å‰å½æˆ–ä¹…ååŠ åŠ‡ç–¼ç—›ï¼Œå¸¸è¦‹æ–¼æ¤é–“ç›¤ç›¸é—œå•é¡Œæˆ–å§¿å‹¢æ€§è…°ç—›ã€‚\n\n"
                "**å»ºè­°ï¼š** ä½¿ç”¨è…°é æ”¯æ’ã€æ¯ 30 åˆ†é˜èµ·èº«æ´»å‹•ã€é¿å…é•·æ™‚é–“åæ²™ç™¼æˆ–ä½çŸ®æ¤…å­ã€‚"
            )
            if "èµ°è·¯ / æ´»å‹•å¾Œæ”¹å–„" in relievers:
                d += "\n\nèµ°è·¯èƒ½ç·©è§£ï¼Œæ›´æ”¯æŒå±ˆæ›²ä¸è€å—çš„åˆ¤æ–·ã€‚"
            if has_nerve_pain and ("è…°" in pain_location or "èƒŒ" in pain_location):
                d += "\n\nåˆä½µç¥ç¶“æ€§ç–¼ç—›ï¼Œéœ€æ³¨æ„æ¤é–“ç›¤çªå‡ºå£“è¿«ç¥ç¶“çš„å¯èƒ½ã€‚"
            movement_notes.append(("pattern-box", "å±ˆæ›²ä¸è€å—ï¼ˆFlexion Intoleranceï¼‰", d))

        # ä¼¸ç›´ä¸è€å—
        ext = [t for t in triggers if t in ["å¾Œä»° / æŒºèº«", "ä¹…ç«™"]]
        if ext:
            d = (
                f"èª˜ç™¼å› å­ï¼š{'ã€'.join(ext)}\n\n"
                "å¾Œä»°æˆ–ä¹…ç«™åŠ åŠ‡ç–¼ç—›ï¼Œå¸¸è¦‹æ–¼è„Šæ¤å°é¢é—œç¯€å•é¡Œã€æ¤ç®¡ç‹¹çª„æˆ–è„Šæ¤æ»‘è„«ã€‚\n\n"
                "**å»ºè­°ï¼š** é¿å…é•·æ™‚é–“ç«™ç«‹æˆ–å¾Œä»°ï¼Œèµ°è·¯æ™‚å¾®å¾®æ”¶å°è…¹ã€‚"
            )
            if "ä¼‘æ¯ / ä¸æ´»å‹•" in relievers:
                d += "\n\nä¼‘æ¯èƒ½ç·©è§£ï¼Œæ”¯æŒçµæ§‹æ€§å£“è¿«çš„å¯èƒ½ã€‚"
            if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                d += "\n\nå¹´é½¡å±¤è¼ƒæ˜“å‡ºç¾é€€åŒ–æ€§è„Šæ¤å•é¡Œï¼Œå»ºè­°å®‰æ’å½±åƒæª¢æŸ¥ã€‚"
            if has_joint_pain:
                d += "\n\nåˆä½µéˆç—›ï¼Œå°é¢é—œç¯€é€€åŒ–æˆ–æ¤ç®¡ç‹¹çª„çš„å¯èƒ½æ€§ä¸Šå‡ã€‚"
            movement_notes.append(("pattern-box", "ä¼¸ç›´ä¸è€å—ï¼ˆExtension Intoleranceï¼‰", d))

        # æ··åˆ
        if flex and ext:
            movement_notes.append(("inflam-box", "æ··åˆæ¨¡å¼ï¼ˆMixed Patternï¼‰",
                "å½æ›²èˆ‡ä¼¸ç›´éƒ½æœƒèª˜ç™¼ç–¼ç—›ï¼Œå¯èƒ½ä¸åªä¸€å€‹çµæ§‹å—å½±éŸ¿ã€‚\n\n"
                "**å»ºè­°ï¼š** ä»¥è„Šæ¤ä¸­ç«‹ä½ç½®ç‚ºä¸»ï¼Œé¿å…æ¥µç«¯è§’åº¦ï¼Œä¸¦å°‹æ±‚å°ˆæ¥­é¢å°é¢è©•ä¼°ã€‚"
            ))

        # æ‰¿é‡ï¼ˆè†è“‹ï¼‰
        stairs = [t for t in triggers if t in ["ä¸Šæ¨“æ¢¯", "ä¸‹æ¨“æ¢¯"]]
        if stairs:
            d = f"èª˜ç™¼å› å­ï¼š{'ã€'.join(stairs)}\n\n"
            if "ä¸‹æ¨“æ¢¯" in stairs and "ä¸Šæ¨“æ¢¯" not in stairs:
                d += "ä¸‹æ¨“æ¢¯ï¼ˆé›¢å¿ƒæ”¶ç¸®ï¼‰è¼ƒç—›ï¼Œå¸¸è¦‹æ–¼é«•éª¨è‚¡éª¨ç–¼ç—›ç—‡å€™ç¾¤ã€é«•éª¨è‚Œè…±ç‚ã€‚"
            elif "ä¸Šæ¨“æ¢¯" in stairs and "ä¸‹æ¨“æ¢¯" not in stairs:
                d += "ä¸Šæ¨“æ¢¯ï¼ˆå‘å¿ƒæ”¶ç¸®ï¼‰è¼ƒç—›ï¼Œå¸¸è¦‹æ–¼è‚¡å››é ­è‚Œè‚ŒåŠ›ä¸è¶³ã€é«•éª¨è»Œè·¡ç•°å¸¸ã€‚"
            else:
                d += "ä¸Šä¸‹æ¨“æ¢¯çš†ç—›ï¼Œè†é—œç¯€æ‰¿é‡èƒ½åŠ›æ˜é¡¯ä¸‹é™ï¼Œå¯èƒ½æ¶‰åŠå¤šé‡çµæ§‹å•é¡Œã€‚"
            if has_locking:
                d += "\n\nåˆä½µå¡ä½æ„Ÿï¼Œéœ€æ³¨æ„åŠæœˆæ¿æˆ–é—œç¯€å…§æ¸¸é›¢é«”çš„å¯èƒ½ã€‚"
            if has_weakness:
                d += "\n\nåˆä½µç„¡åŠ›æ„Ÿï¼Œè†è“‹å‘¨é‚Šè‚ŒåŠ›å·²æ˜é¡¯ä¸è¶³ã€‚"
            if has_joint_pain:
                d += "\n\nåˆä½µéˆç—›ï¼Œå¯èƒ½æ¶‰åŠè»Ÿéª¨ç£¨æç­‰é€€åŒ–æ€§å•é¡Œã€‚"
            d += "\n\n**å»ºè­°ï¼š** æš«æ™‚æ¸›å°‘æ¨“æ¢¯ä½¿ç”¨æˆ–æ‰¶æ‰¶æ‰‹æ¸›å°‘è² è·ï¼Œè€ƒæ…®å¾åå§¿ä¼¸è†ã€é ç‰†åŠè¹²ç­‰ä½è² è·è¨“ç·´é–‹å§‹ã€‚"
            movement_notes.append(("pattern-box", "æ‰¿é‡æ¨¡å¼ç•°å¸¸ï¼ˆWeight-Bearing Patternï¼‰", d))

        # è‚©è†€ä¸Šèˆ‰
        if "æ‰‹èˆ‰é«˜" in triggers:
            d = "æ‰‹èˆ‰éé ­ç–¼ç—›ï¼Œå¯èƒ½æ¶‰åŠè‚©å¤¾æ“ ç—‡å€™ç¾¤æˆ–æ—‹è½‰è‚Œç¾¤å•é¡Œã€‚"
            if "è‚©è†€" in pain_location:
                d += "\n\néƒ¨ä½ç‚ºè‚©è†€ï¼Œæ›´æ”¯æŒæ—‹è½‰è‚Œç¾¤æå‚·ã€è‚©å³°ä¸‹æ»‘å›Šç‚æˆ–è‚©èƒ›æ§åˆ¶ä¸è‰¯ã€‚"
            if has_weakness:
                d += "\n\nåˆä½µç„¡åŠ›æ„Ÿï¼Œéœ€æ³¨æ„æ—‹è½‰è‚Œç¾¤å¯èƒ½æœ‰æ’•è£‚ï¼Œå»ºè­°å®‰æ’è¶…éŸ³æ³¢æˆ– MRIã€‚"
            if "å½±éŸ¿ç¡çœ " in impacts:
                d += "\n\nå·²å½±éŸ¿ç¡çœ ï¼ˆå°¤å…¶å´ç¡å£“åˆ°æ‚£å´ï¼‰ï¼Œå¸¸è¦‹æ–¼æ—‹è½‰è‚Œç¾¤æå‚·ã€‚"
            if has_muscle_pain:
                d += "\n\nåˆä½µç·Šç¹ƒ / é…¸ç—›ï¼Œè‚©é ¸è‚Œç¾¤ä»£å„Ÿæ€§ç·Šç¹ƒä¹Ÿéœ€ä¸€ä½µè™•ç†ã€‚"
            d += "\n\n**å»ºè­°ï¼š** æš«æ™‚é¿å…æ‰‹èˆ‰éè‚©çš„å‹•ä½œï¼Œå…ˆå¾ä½è² è·è‚©èƒ›ç©©å®šè¨“ç·´é–‹å§‹ã€‚"
            movement_notes.append(("pattern-box", "ä¸Šèˆ‰å—é™ï¼ˆOverhead Impingement Patternï¼‰", d))

        # æ—‹è½‰ä¸è€å—
        if "è½‰èº« / è½‰å½" in triggers:
            movement_notes.append(("pattern-box", "æ—‹è½‰ä¸è€å—ï¼ˆRotation Intoleranceï¼‰",
                "è½‰èº«æˆ–è½‰å½æ™‚ç–¼ç—›ï¼Œå¯èƒ½æ¶‰åŠè„Šæ¤æ—‹è½‰çµæ§‹æˆ–æ ¸å¿ƒç©©å®šä¸è¶³ã€‚\n\n"
                "**å»ºè­°ï¼š** ä»¥æ•´å€‹èº«é«”ä¸€èµ·è½‰å–ä»£åªè½‰è…°ï¼ŒåŠ å¼·æ ¸å¿ƒæŠ—æ—‹è½‰è¨“ç·´ï¼Œé¿å…çªç„¶å¿«é€Ÿè½‰èº«ã€‚"
            ))

        # æ­¥è¡Œ
        if "èµ°è·¯" in triggers:
            d = "èµ°è·¯æœƒå¼•ç™¼ç–¼ç—›ï¼Œå¯èƒ½åŸå› ä¾éƒ¨ä½è€Œç•°ï¼š\n\n"
            if "è…³è¸" in pain_location or "è¶³éƒ¨" in pain_location:
                d += "- è¶³è¸ï¼šè¶³åº•ç­‹è†œç‚ã€è·Ÿè…±ç‚ã€è¸é—œç¯€ä¸ç©©å®š\n"
            elif "è†" in pain_location:
                d += "- è†è“‹ï¼šè»Ÿéª¨ç£¨æã€æ‰¿é‡è»¸ç·šç•°å¸¸\n"
            elif "è…°" in pain_location or "èƒŒ" in pain_location:
                d += "- è…°æ¤ï¼šæ¤ç®¡ç‹¹çª„ï¼ˆé–“æ­‡æ€§è·›è¡Œï¼‰ã€è„Šæ¤ä¸ç©©å®š\n"
            elif "é«–" in pain_location:
                d += "- é«–éƒ¨ï¼šé«–é—œç¯€é€€åŒ–ã€å½ˆéŸ¿é«–ã€è‡€ä¸­è‚Œç„¡åŠ›\n"
            else:
                d += "- å»ºè­°é‡å°å…·é«”éƒ¨ä½é€²ä¸€æ­¥è©•ä¼°\n"
            if has_nerve_pain and ("è…°" in pain_location or "èƒŒ" in pain_location):
                d += "\nåˆä½µç¥ç¶“æ€§ç–¼ç—›ï¼‹èµ°è·¯åŠ åŠ‡ï¼‹è…°æ¤éƒ¨ä½ï¼Œéœ€è€ƒæ…®æ¤ç®¡ç‹¹çª„çš„å¯èƒ½ï¼ˆé–“æ­‡æ€§è·›è¡Œï¼‰ã€‚"
            movement_notes.append(("pattern-box", "æ­¥è¡Œç–¼ç—›ï¼ˆGait-Related Painï¼‰", d))

        if movement_notes:
            for box_cls, title, detail in movement_notes:
                st.markdown(f'<div class="{box_cls}">{title}</div>', unsafe_allow_html=True)
                st.markdown(detail)
                st.write("")
        else:
            st.info("æœªé¸æ“‡æ˜é¡¯èª˜ç™¼å› å­ï¼Œå»ºè­°ç”±ç‰©ç†æ²»ç™‚å¸«é€²è¡Œç¾å ´å‹•ä½œè©•ä¼°ã€‚")

        # --- C. ç·©è§£å› å­ ---
        st.markdown("##### C. ç·©è§£å› å­åˆ†æ")
        relief_notes = []

        if "ç†±æ•·" in relievers and "å†°æ•·" in relievers:
            relief_notes.append(
                "**ç†±æ•·èˆ‡å†°æ•·çš†æœ‰æ•ˆï¼š** æ‚£è™•å¯èƒ½åŒæ™‚å­˜åœ¨è‚Œè‚‰ç·Šç¹ƒèˆ‡è¼•å¾®ç™¼ç‚ã€‚"
                "å»ºè­°æ€¥æ€§æœŸä»¥å†°æ•·ç‚ºä¸»ï¼Œæ…¢æ€§æœŸä»¥ç†±æ•·ç‚ºä¸»ã€‚"
            )
        elif "ç†±æ•·" in relievers:
            n = "**ç†±æ•·æœ‰æ•ˆï¼š** é¡¯ç¤ºè‚Œè‚‰ç·Šç¹ƒæˆ–å¾ªç’°ä¸è‰¯å¯èƒ½ç‚ºä¸»è¦å•é¡Œã€‚"
            if has_muscle_pain:
                n += " åˆä½µç·Šç¹ƒ / é…¸ç—›çš„ç–¼ç—›æ€§è³ªï¼Œè‚Œç­‹è†œå•é¡Œçš„å¯èƒ½æ€§è¼ƒé«˜ã€‚"
            relief_notes.append(n)
        elif "å†°æ•·" in relievers:
            n = "**å†°æ•·æœ‰æ•ˆï¼š** ç›®å‰æ‚£è™•å¯èƒ½ä»æœ‰æ€¥æ€§ç™¼ç‚æˆ–è…«è„¹ã€‚å»ºè­°æ¯æ¬¡ 15â€“20 åˆ†é˜ã€‚"
            if has_inflam_pain:
                n += " åˆä½µç¼ç†±æ„Ÿï¼Œç™¼ç‚åæ‡‰è¼ƒæ˜ç¢ºã€‚"
            relief_notes.append(n)

        if "èµ°è·¯ / æ´»å‹•å¾Œæ”¹å–„" in relievers:
            n = "**æ´»å‹•å¾Œç·©è§£ï¼š** å‹•ä¸€å‹•åè€Œèˆ’æœï¼Œ"
            if "ä¹…å" in triggers or "ä¹…ç«™" in triggers:
                n += "çµåˆä¹…å / ä¹…ç«™èª˜ç™¼çš„ç‰¹å¾µï¼Œé€™æ˜¯å…¸å‹çš„ã€Œè¶Šä¸å‹•è¶Šç—›ã€æ¨¡å¼ã€‚å»ºè­°è¦å¾‹æ´»å‹•ã€‚"
            else:
                n += "ä»£è¡¨æ´»å‹•æœ‰åŠ©æ–¼å¢åŠ å¾ªç’°èˆ‡é—œç¯€æ½¤æ»‘ã€‚"
            if age in ["46-60æ­²", "60æ­²ä»¥ä¸Š"]:
                n += " ä¸­è€å¹´æ—ç¾¤çš„ã€Œæ™¨åƒµã€ç¾è±¡ä¹Ÿå±¬æ­¤é¡ã€‚"
            if has_joint_pain:
                n += " åˆä½µéˆç—›ï¼‹æ´»å‹•å¾Œæ”¹å–„ï¼Œé€€åŒ–æ€§é—œç¯€ç‚çš„æ¨¡å¼å€¼å¾—æ³¨æ„ã€‚"
            relief_notes.append(n)

        if "æ”¹è®Šå§¿å‹¢" in relievers:
            relief_notes.append("**æ”¹è®Šå§¿å‹¢æœ‰æ•ˆï¼š** ç–¼ç—›èˆ‡ç‰¹å®šå§¿å‹¢é«˜åº¦ç›¸é—œã€‚å»ºè­°æ‰¾å‡ºèˆ’é©å§¿å‹¢ä¸¦é¿å…ç¶­æŒç–¼ç—›å§¿å‹¢éä¹…ã€‚")

        if "ä¼‘æ¯ / ä¸æ´»å‹•" in relievers and "èµ°è·¯ / æ´»å‹•å¾Œæ”¹å–„" not in relievers:
            relief_notes.append("**ä¼‘æ¯æœ‰æ•ˆä½†æ´»å‹•æœªæ”¹å–„ï¼š** æ‚£è™•å¯èƒ½ä»è™•ç™¼ç‚éšæ®µï¼Œè² è·æœƒåŠ é‡ç—‡ç‹€ã€‚ä»¥ç›¸å°ä¼‘æ¯ç‚ºä¸»ä½†éå®Œå…¨ä¸å‹•ã€‚")

        if "æ²’æœ‰ä»»ä½•æ”¹å–„" in relievers:
            n = "**ä»»ä½•æ–¹å¼çš†ç„¡æ³•æ”¹å–„ï¼š** ç–¼ç—›ä¾†æºå¯èƒ½è¼ƒç‚ºè¤‡é›œï¼ˆå¦‚ä¸­æ¨æ•æ„ŸåŒ–ã€å¤šçµæ§‹å•é¡Œï¼‰ã€‚"
            if has_nerve_pain:
                n += " åˆä½µç¥ç¶“æ€§ç–¼ç—›ç‰¹å¾µï¼Œå¯èƒ½éœ€è¦é‡å°ç¥ç¶“æœ¬èº«é€²è¡Œæ²»ç™‚ã€‚"
            n += " **å¼·çƒˆå»ºè­°å°‹æ±‚å°ˆæ¥­è©•ä¼°ã€‚**"
            relief_notes.append(n)

        if relief_notes:
            for rn in relief_notes:
                st.markdown(f"- {rn}")
            st.write("")
        else:
            st.info("æœªé¸æ“‡ç·©è§£å› å­ã€‚å»ºè­°ç´€éŒ„ä»€éº¼ç‹€æ³ä¸‹ç—‡ç‹€æœƒæ¸›è¼•ï¼Œæœ‰åŠ©æ–¼å¾ŒçºŒè¨ºæ–·ã€‚")

        # --- D. åŠŸèƒ½å½±éŸ¿ ---
        if impacts:
            st.markdown("##### D. åŠŸèƒ½å½±éŸ¿è©•ä¼°")
            if "å½±éŸ¿ç¡çœ " in impacts:
                n = "**ç¡çœ å—å½±éŸ¿ï¼š** å¤œé–“ç—›æˆ–ç„¡æ³•æ‰¾åˆ°èˆ’é©ç¡å§¿ï¼Œä»£è¡¨å•é¡Œå¯èƒ½è¼ƒåš´é‡ã€‚"
                if has_inflam_pain:
                    n += " åˆä½µç¼ç†±æ„Ÿï¼Œå¤œé–“ç™¼ç‚åæ‡‰å¯èƒ½è¼ƒå¼·ã€‚"
                st.markdown(f"- {n}")
            if "å¤±å»å¹³è¡¡" in impacts:
                n = "**å¹³è¡¡ / è·Œå€’é¢¨éšªï¼š** å¤±å»å¹³è¡¡ç‚ºé‡è¦å®‰å…¨è­¦è¨Šã€‚"
                if has_nerve_pain:
                    n += " åˆä½µç¥ç¶“æ€§ç–¼ç—›ï¼‹å¤±å»å¹³è¡¡ï¼Œéœ€ç‰¹åˆ¥æ³¨æ„è„Šé«“å£“è¿«ï¼ˆMyelopathyï¼‰çš„å¯èƒ½ï¼Œå»ºè­°å„˜é€Ÿå°±é†«ã€‚"
                st.markdown(f"- {n}")
            if "éœ€è—¥ç‰©æ­¢ç—›" in impacts:
                st.markdown("- **éœ€è—¥ç‰©æ§åˆ¶ï¼š** é•·æœŸä¾è³´æ­¢ç—›è—¥å¯èƒ½æ©è“‹çœŸæ­£å•é¡Œã€‚å»ºè­°æ­é…ç‰©ç†æ²»ç™‚æ‰¾å‡ºæ ¹æœ¬åŸå› ã€‚")
            if "å½±éŸ¿æ—¥å¸¸" in impacts:
                st.markdown("- **æ—¥å¸¸åŠŸèƒ½å—é™ï¼š** åŸºæœ¬æ´»å‹•å·²å—å½±éŸ¿ï¼Œå»ºè­°ç©æ¥µå°‹æ±‚æ²»ç™‚ä»‹å…¥ã€‚")

        # === çµå°¾å»ºè­° ===
        st.markdown("---")
        st.markdown("#### ç¶œåˆå»ºè­°")

        if has_red_flags:
            st.error("**ç«‹å³å°±é†«** â€” æ‚¨æœ‰ç´…æ——è­¦è¨Šï¼Œå»ºè­°å„˜é€Ÿå°±é†«é€²è¡Œè©³ç´°æª¢æŸ¥ã€‚")
        elif vas_score >= 7:
            st.warning("**å»ºè­°å°±é†«** â€” é›–ç„¡ç´…æ——è­¦è¨Šï¼Œä½†ç–¼ç—›æŒ‡æ•¸åé«˜ï¼Œå»ºè­°ç›¡å¿«å°±é†«æˆ–æ¥å—ç‰©ç†æ²»ç™‚è©•ä¼°ã€‚")
        elif vas_score >= 4:
            st.info("**å»ºè­°è¿½è¹¤** â€” ä¸­åº¦ç–¼ç—›ï¼Œå»ºè­°å®‰æ’ç‰©ç†æ²»ç™‚å¸«é€²è¡Œå®Œæ•´è©•ä¼°ï¼Œä¸¦ç•™æ„å‹•ä½œæ¨¡å¼èª¿æ•´ã€‚")
        else:
            st.success("**æŒçºŒè§€å¯Ÿ** â€” ç›®å‰ç–¼ç—›ç¨‹åº¦è¼ƒè¼•ï¼Œå¯å…ˆé€éè¡›æ•™èˆ‡è‡ªæˆ‘ç®¡ç†æ”¹å–„ï¼Œè‹¥æŒçºŒä¸é©å†å°±é†«ã€‚")

        st.markdown("---")
        st.caption(
            "æœ¬å ±å‘Šåƒ…ä¾›è¡›æ•™åƒè€ƒï¼Œä¸å¯å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚å¦‚æœ‰ç–‘æ…®è«‹è«®è©¢é†«å¸«æˆ–ç‰©ç†æ²»ç™‚å¸«ã€‚"
            "ã€€ï½œã€€æœ¬å ±å‘Šå¯æˆªåœ–ä¿å­˜ï¼Œæ”œå¸¶è‡³å°±è¨ºæ™‚æä¾›é†«ç™‚äººå“¡åƒè€ƒã€‚"
        )